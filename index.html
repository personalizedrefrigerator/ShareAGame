<!DOCTYPE html>
<html>
<head>
<!-- Made by Henry Heino in 2018 -->
<title>Game</title>

<link rel = "icon" href = "favicon.png"/>

<meta name = "viewport" content="width=device-width"/>
<meta content = "text/html;charset=utf-8" http-equiv = "content-type"/>
<meta content = "utf-8" http-equiv = "encoding"/>

<script src = "Vector.js"></script>
<script src = "Matrix.js"></script>
<script src = "Objects.js"></script>
<script src = "RoomSimulation.js"></script>
<script src = "DrawingDisplay.js"></script>

<style>
body
{
    background-color: blue;
    background-image: radial-gradient(rgba(200, 200, 200, 0.9), white);
    background-size: 5px 5px;/*0.5vw 0.5vh;*/
    touch-action: none !important;
}

@keyframes fadeIn
{
    0% { filter: opacity(0%); };
    50% { filter: opacity(50%); };
    100% { filter: opacity(100%); };
}

@keyframes fadeOut
{
    0% { filter: opacity(100%); };
    50% { filter: opacity(50%); };
    100% { filter: opacity(0%); };
}

::selection
{
    background: rgba(0, 140, 220, 0.5);
    color: #ffffff;
}

::-moz-selection
{
    background: rgba(0, 140, 220, 0.5);
    color: #ffffff;
}

.draggableHelper
{
    z-index: 2000;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    outline: 10% solid blue;
}

.termsOfUse
{
    font: bold 50% Sans;
    background-color: rgba(255, 255, 255, 0.2);
    outline: 1px dotted rgba(200, 200, 200, 0.7);
    text-indent: 5px;
}

.alert
{
    border: 1px solid black;
    background-color: yellow;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    z-index: 999;
    transition: 1s ease all;
    box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.0);
    filter: opacity(50%);
    transform: matrix(1, 0, 0, 1, 0, 0);
    animation: 1s linear fadeIn;
}

.alert:hover
{
    box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
    filter: opacity(100%);
    transform: matrix(1, 0, 0, 1.5, 0, 0);
}

.tabHeader
{
    border-bottom: 2px ridge black;
    font: 14pt Serif;
}

.tabLabel
{
    outline: 2px groove orange;
    padding-top: 5px;
    padding-bottom: 5px;
    background-image: linear-gradient(12deg, white, rgba(240, 220, 220, 0.7), white);
    cursor: pointer;
    box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.3);
    filter: opacity(75%);
    transform: matrix(1, 0, 0, 1, 0, 0);
    font-weight: bold;
    transition: 0.2s ease all;
    animation: fadeIn;
}

.tabLabel:hover
{
    box-shadow: 2px 2px 3px rgba(0, 0, 0, 0.7);
    background-image: linear-gradient(12deg, white, rgba(245, 220, 220, 0.75), white);
    transform: matrix(0.99, 0.005, 0, 1.01, 0, 0);
    filter: opacity(100%);
}

.signInMenu
{
    margin-left: auto;
    margin-right: auto;
    border: 2px ridge gray;
    box-shadow: 2px 14px 10px rgba(0, 0, 0, 0.4);
    background: linear-gradient(15deg, rgba(255, 255, 255, 0.5), rgba(220, 205, 200, 0.7));
    transition: 0.3s ease all;
    padding: 15px;
    width: 50%;
    height: 400px;
    overflow-y: scroll;
    margin-top: auto;
    margin-bottom: auto;
    transform: matrix(1, 0.005, 0.001, 1, 0, 0);
    animation: 0.5s linear fadeIn;
}

.signInMenu:hover
{
    box-shadow: 14px 14px 20px rgba(0, 0, 0, 0.8);
    background: linear-gradient(15deg, rgba(255, 255, 255, 0.5), rgba(255, 255, 200, 0.7));
    transform: matrix(1, 0, 0, 1, 0, 0);
}

.windowTitleBar, .windowCloseButton
{
    font: 20pt Sans;
}

.windowContent
{
    overflow-y: auto;
    width: 100%;
}

.windowTitleBar
{
    height: 1em;
    overflow: hidden;
    cursor: default;
}

.baseWindowTitleBar
{
    border: 1px solid black;
    background-image: radial-gradient(white, rgba(100, 100, 100, 0.7));
    background-size: 5px 5px;
}

.window
{
    position: fixed;
}

.baseWindow
{
    border: 1px solid black;
    background-color: white;
    top: 10vh;
    left: 30vh;
    width: 40vh;
    height: 50vh;
    transition: 0.5s ease background-color, border;
    filter: opacity(100%);
    animation: 0.5s linear fadeIn;
    box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.4);
}

.windowCloseButton
{
    width: 1.2em;
    height: 1em;
    text-align: center;
    float: right;
    cursor: pointer;
    position: absolute;
    top: 0;
    right: 0;
}

.baseWindowCloseButton, .chatAreaWindowCloseButton, .controlsWindowCloseButton
{
    border: 2px solid rgba(255, 255, 255, 1.0);
    border-radius: 2px;
    
    background-color: red;
    background-image: linear-gradient(100deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.4));
    
    color: white;
    text-shadow: 1px 1px rgba(0, 0, 0, 0.5);
    
    background-size: 100% 100%;
    box-shadow: -2px -2px 0px rgba(0, 0, 0, 0.0);
    
    transition: 0.4s ease all;
}

.baseWindowCloseButton:hover, .chatAreaWindowCloseButton:hover, .controlsWindowCloseButton:hover
{
    border: 2px solid rgba(250, 250, 250, 0.8);
    background-size: 200% 200%;
    box-shadow: -2px -2px 2px rgba(0, 0, 0, 0.5);
}

.windowDragCircle
{   
    display: inline;
    float: right;
    
    position: absolute;
    bottom: 0px;
    right: 0px;
    
    cursor: move;
}

.baseWindowDragCircle
{
    background-color: rgba(100, 100, 100, 0.5);
    background-image: radial-gradient(rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.5));
    
    border: 1px solid black;
    border-radius: 50%;
    padding: 20px;
    
    z-index: 150;
}

.controlsWindow
{
    left: 0 !important;
    border: 3px solid rgba(255, 235, 0, 0.5);
    
    background-color: rgba(255, 155, 100, 0.5);
    background-image: linear-gradient(10deg, rgba(0, 0, 0, 0.1), rgba(0, 0, 100, 0.5), rgba(0, 0, 0, 0.2));
    background-size: 1px 100%;
    
    box-shadow: -1px -2px 3px rgba(0, 0, 0, 0.5);
    
    border-radius: 4px;
    filter: sepia(10%);
}

.controlsWindowDragCircle
{
    background-color: rgba(100, 200, 100, 0.5);
    background-image: radial-gradient(rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.5));
    
    border: 1px solid black;
    border-radius: 50%;
    padding: 18px;
}

.controlsWindowTitleBar
{
    outline: 2px solid rgba(255, 235, 0, 1);
    background-image: radial-gradient(white, rgba(100, 100, 100, 0.7));
    background-size: 4px 8px;
    filter: sepia(100%) hue-rotate(10deg) blur(0.5px);
}

.chatAreaWindow
{
    border: 1px outset white;
    border-radius: 5px;
    padding: 5px;
    
    color: #dddddd;
    
    box-shadow: -2px -3px 3px rgba(0, 0, 0, 0.5);
    background-color: rgba(112, 60, 112, 0.4);
    background-image: linear-gradient(23deg, rgba(112, 60, 112, 0.8), rgba(200, 150, 200, 0.0));

    right: 0;
    bottom: 0;
}

.chatAreaWindowDragCircle
{
    background-color: rgba(100, 100, 100, 0.5);
    background-image: radial-gradient(rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.5));
    
    border: 1px dashed black;
    border-radius: 50%;
    padding: 10px;
}

.chatAreaWindowCloseButton
{
    background-color: green !important;
    border: 1px solid rgba(255, 255, 255, 1.0);
    filter: sepia(50%) opacity(50%);
    transform: rotate(3deg);
}

.chatAreaWindowTitleBar
{
    outline: 2px solid rgba(100, 100, 100, 0.1);
    border-radius: 3px;
    filter: sepia(30%);
}

.userNameDisplay
{
    color: #aaffaa;
}

input::placeholder
{
    text-shadow: 3px 3px rgba(0, 255, 0, 0.4);
    opacity: 100% !important;
    color: rgba(0, 0, 0, 0.7);
    font: 12pt 'Times New Roman', Serif;
}

input, button
{
    padding: 5px;
    background-color: white;
    background-image: linear-gradient(30deg, white, rgba(255, 200, 225, 0.6), rgba(255, 255, 220, 0.9));
    border: 1px ridge gray;
    filter: sepia(50%);
    box-shadow: 2px 2px 1px rgba(0, 0, 0, 0.1);
    font: 12pt 'Times New Roman', Serif;
    
    
    transition: 1s ease all;
}

input:focus, button:hover
{   
    box-shadow: 2px 2px 7px rgba(255, 100, 0, 0.5);
    filter: sepia(10%);
}

button, input[type="button"]
{
    border-radius: 14px;
    margin: 4px;
    transform: matrix(1, 0, 0, 1, 0, 0);
}

button:hover, input[type="button"]:hover
{
    transform: matrix(0.96, -0.01, 0.01, 1, 0, 0);
}

h1, h2, h3
{
    border-bottom: 2px groove gray;
    padding-bottom: 6px;
    font: bold 24pt Serif;
    box-shadow: 0px 2px 0px rgba(0, 0, 0, 0.5);
}

.pendingButton
{
    background-color: blue;
}

.zoomDiv
{
    position: fixed;
    left: 0;
    bottom: 0;
    z-index: 10;
}

.userStatus
{
    border: 2px solid gray;
    background: radial-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.5));
    background-color: rgba(100, 100, 100, 0.5);
    border-radius: 5px;
    display: inline-block;
    height: 1.5em;
    padding-top: 0.5em;
    
    color: white;
    filter: blur(0.5px);
    
    box-shadow: -3px -2px 4px rgba(0, 0, 0, 0.5);
    transition: 0.5s linear all;
}

.userStatus:hover
{
    cursor: pointer;
    background-color: rgba(200, 200, 200, 0.5);
}

.characterList
{
    padding-top: 1em;
    padding-bottom: 1em;
    
    border: 5px outset rgba(0, 100, 100, 0.5);
    border-top-left-radius: 15px;
    
    transform: matrix(1, 0, 0, 1, 0, 0);
    transition: 0.5s ease transform;
}

.characterList:hover
{
    transform: matrix(1, 0.01, -0.01, 1, 0, 0);
}

.characterList > div
{
    padding-left: 1em;
    padding-right: 1em;
    background-image: linear-gradient(90deg, gray, lightgray, gray);
}

.characterList div:nth-child(odd)
{
    background-color: rgba(255, 255, 255, 0.4);
}

.characterList div:nth-child(even)
{
    filter: invert(100%);
    background-color: rgba(255, 255, 255, 0.4);
}

.boundedInputOk
{
    background-color: rgba(255, 255, 255, 0.5);
    
    transition: 0.5s ease all;
}

.boundedInputOversize
{
    background-color: rgba(255, 0, 0, 0.7);
}

.errorDescription
{
    color: red;
    padding-left: 5px;
    font-weight: bold;
}

.statusText
{
    position: fixed;
    text-align: center;
    bottom: 10%;
    left: 0;
    right: 0;
    width: 100%;
    
    font: bold 48pt Serif;
    text-shadow: -3px -2px 4px rgba(0, 0, 0, 0.7);
    color: rgba(100, 255, 100, 1);
    
    background-image: linear-gradient(10deg, rgba(0, 0, 0, 0.0), rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.0));
    
    z-index: 11;
}

.article > p
{
    text-indent: 15px;
    font: 12pt Serif;
}

.article > h2
{
    font-size: 18pt;
    font-family: Sans;
}

.article > h3
{
    font-size: 14pt;
    font-family: Serif;
}

.article > code
{
    word-wrap: break-word;
}
</style>
</head>
<body>
<noscript class = "alert">Please use a JavaScript supporting browser!</noscript>
<div class = "alert">The page is loading or an error occured!</div>
<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
</body>

<script>
    var progress = 0;
    try
    {
      // Initialize Firebase
      var config =
      {
        apiKey: "AIzaSyAt-B8trwHbbGKNOxYqZvuL5xvBu1XRtHg",
        authDomain: "share-dgame.firebaseapp.com",
        databaseURL: "https://share-dgame.firebaseio.com",
        projectId: "share-dgame",
        storageBucket: "share-dgame.appspot.com",
        messagingSenderId: "140193694570"
      };


      firebase.initializeApp(config);
      
      progress = 1;
      
      window.database = firebase.database();
      var users = database.ref("users");
      
      progress = 2;
      
      window.users = database.ref("users");
      window.gameData = database.ref("gameData");
      
      progress = 3;
      
      window.authorization = firebase.auth();
      window.storage=firebase.storage();
      window.storageRef=storage.ref();
  }
  catch(e)
  {
    window.firebaseError = e + ". Help: window.firebase: " + window.firebase + ", ";
    window.firebaseError += "Pages: " + window.pages + ". Progress: " + progress + ".";
  }
</script>

<script>
var AuthorizationHelper = 
{
    "authListeners": [],
    "authLoop": false,
    "hasAccess": false,
    "accessListeners": [],
    "justDidSignUp": false,
    "addAuthListener": function(listener)
    {
        if(!AuthorizationHelper.authLoop)
        {
            AuthorizationHelper.authLoop = true;
            window.authorization.onAuthStateChanged(function()
            {
                for(var index = 0; index < AuthorizationHelper.authListeners.length; index++)
                {
                    if(typeof AuthorizationHelper.authListeners[index] === "function")
                    {
                        AuthorizationHelper.authListeners[index]();
                    }
                }
            });
        }
        
        AuthorizationHelper.authListeners.push(listener);
    },
    "addAccessListener": function(listener)
    {
        AuthorizationHelper.accessListeners.push(listener);
    },
    "checkForAccess": function(onComplete)
    {
        var user = window.authorization.currentUser;
        users.child(user.uid).child("access").once("value", function(data)
        {
            var json = data.val();
            
            if(json !== null)
            {
                AuthorizationHelper.hasAccess = json;
            }
            else
            {
                AuthorizationHelper.hasAccess = false;
            }
            
            for(var i = 0; i < AuthorizationHelper.accessListeners.length; i++)
            {
                AuthorizationHelper.accessListeners[i](AuthorizationHelper.hasAccess);
            }
            
            if(onComplete)
            {
                onComplete(AuthorizationHelper.hasAccess);
            }
        }).catch(function()
        {
            if(!AuthorizationHelper.justDidSignUp)
            {
                AuthorizationHelper.storeUserData(false);
            }
        });
    },
    "storeUserData": function(doNotConfirmStorage, onComplete)
    {
        var storeData = function()
        {
            var user = window.authorization.currentUser;
            
            if(!user.emailVerified)
            {
                SubWindowHelper.alert("Warning!", "Please verify your email address.");
            }
            
            var setTo = {
                "access": false,
                "characters":
                {
                
                },
                "userData":
                {
                    "name": user.displayName,
                    "email": user.email
                }
            };
            
            user.getIdToken(true).then(function(token)
            {
                console.log(token);
            
                users.child(user.uid).set(setTo).then(function()
                {
                    SubWindowHelper.alert("Data Creation", "Data creation is complete.");
                }).catch(function(error)
                {
                    SubWindowHelper.alert("Error!", "Error storing data: " + error.message + ". To store: " + JSON.stringify(setTo) + ".  YOU MAY HAVE TO VERIFY YOUR EMAIL ADDRESS. See the \"Account Options\" tab.");
                });
            }).catch(function(error)
            {
                SubWindowHelper.alert("Error!", "Error storing data: " + error.message + ". Error in getting token. To store: " + JSON.stringify(setTo) + ".");
            });
        };
        
        if(!doNotConfirmStorage)
        {
            SubWindowHelper.confirm("Initialize Data", "Associate data with this account? This may be necessary to play the game. If data is already stored, this will delete that data. Verify your email address first.", function(response)
            {
                if(response)
                {
                    storeData();
                }
            }, undefined, "Yes", "No");
        }
    },
    "defineUserDataIfNeeded": function()
    {
        var user = window.authorization.currentUser;
        var userData = users.child(user.uid);
        
        if(AuthorizationHelper.justDidSignUp)
        {
            console.warn("Exiting defineUserDataIfNeeded as the user has just signed up.");
            
            return;
        }
        
        userData.once("value", function(data)
        {
            if(data.val() === null)
            {
                AuthorizationHelper.storeUserData(false);
            }
        });
    },
    "updateUserData": function(onComplete)
    {
        var user = window.authorization.currentUser;
        users.child(user.uid).child("userData").set(
        {
            "name": user.displayName,
            "email": user.email
        }).then(function()
        {
            onComplete();
        }).catch(function(error)
        {
            SubWindowHelper.alert("Error!", "Error publicizing user data: " + error.message);
        });
    },
    "getHasAccess": function()
    {
        return AuthorizationHelper.hasAccess;
    },
    "activeChangeLoopRunning": false,
    "activeUsers": {},
    "activeUsersChangedListeners": [],
    "addActiveUserChangeListener": function(listener)
    {
        AuthorizationHelper.activeUsersChangedListeners.push(listener);
    },
    "noteInfoChange": function()
    {
        var user = window.authorization.currentUser;
        
        if(user)
        {
            user.getIdToken(true).then(function(token)
            {
                var signedInUsers = database.ref("signedInUsers");
                
                signedInUsers.child(user.uid).set(user.displayName || user.email).catch(function(error)
                {
                    SubWindowHelper.alert("Error Noting Sign in Status Change", error);
                });
            });
        }
    },
    "noteSignOut": function(onComplete)
    {
        var signedInUsers = database.ref("signedInUsers");
        var user = window.authorization.currentUser;
        
        signedInUsers.child(user.uid).set(null).then(function()
        {
            onComplete(true);
        }).catch(function(error)
        {
            if(error && !AuthorizationHelper.justDidSignUp)
            {
                SubWindowHelper.alert("Error Noting Disconnect!", error);
            }
            else
            {
                console.warn(error);
            }
            
            onComplete(error);
        });
    },
    "startActiveChangeLoop": function()
    {
        if(!AuthorizationHelper.activeChangeLoopRunning && !AuthorizationHelper.justDidSignUp)
        {
            AuthorizationHelper.activeChangeLoopRunning = true;
            
            var signedInUsers = database.ref("signedInUsers");
            
            var signedIn = false;
            var notifyActiveUserListeners = function(key, information)
            {
                for(var i = 0; i < AuthorizationHelper.activeUsersChangedListeners.length; i++)
                {
                    AuthorizationHelper.activeUsersChangedListeners[i](key, AuthorizationHelper.activeUsers, information);
                }
            };
            
            var startUserCheck = function()
            {
                var user = window.authorization.currentUser;
                if(user)
                {
                    CommunicationHelper.addResourceListener("signedInUsers", function(json, data)
                    {
                        AuthorizationHelper.activeUsers[data.key] = json;
                        
                        notifyActiveUserListeners(data.key, "signIn");
                    }, "child_added");
                    
                    CommunicationHelper.addResourceListener("signedInUsers", function(json, data)
                    {
                        AuthorizationHelper.activeUsers[data.key] = json;
                        
                        notifyActiveUserListeners(data.key, "dataChange");
                    }, "child_changed");
                    
                    CommunicationHelper.addResourceListener("signedInUsers", function(json, data)
                    {
                        if(data.key)
                        {
                            delete AuthorizationHelper.activeUsers[data.key];
                        }
                        
                        notifyActiveUserListeners(data.key, "signOut");
                    }, "child_removed");
                }
            };
            
            var noteExitListener = function()
            {
                var user = window.authorization.currentUser;
                
                if(user)
                {
                    signedInUsers.child(user.uid).onDisconnect().set(null).catch(function(error)
                    {
                        if(error && !AuthorizationHelper.justDidSignUp)
                        {
                            SubWindowHelper.alert("Error Noting Disconnect!", error);
                        }
                        else
                        {
                            console.warn(error);
                        }
                    });
                }
                else
                {
                    SubWindowHelper.alert("Error!", "Unable to note sign-outs.");
                }
            };
            
            var entranceListenerRunning = false;
            var noteEntranceListener = function(count)
            {
                count = count || 1;
                if(!entranceListenerRunning)
                {
                    entranceListenerRunning = true;
                    database.ref(".info/connected").on("value", function(data)
                    {
                        if(data.val() === true)
                        {
                            var user = window.authorization.currentUser;
                            
                            
                            user.getIdToken(true).then(function(token)
                            {
                                signedInUsers.child(user.uid).set(user.displayName || user.email).catch(function(error)
                                {
                                    if(!AuthorizationHelper.justDidSignUp)
                                    {
                                        SubWindowHelper.alert("Error Setting Signed In Status", error);
                                    }
                                    else
                                    {
                                        console.warn(error);
                                    }
                                });
                            });
                            AuthorizationHelper.connected = true;
                        }
                        else
                        {
                            AuthorizationHelper.connected = false;
                        }
                    }, function()
                    {
                        entranceListenerRunning = false;
                    });
                }
                else if(count <= 10)
                {
                    console.log(count);
                    setTimeout(function(){ noteEntranceListener(++count); }, 1000);
                }
            };
            
            AuthorizationHelper.addAuthListener(function()
            {
                var newSignedIn = window.authorization.currentUser != undefined;
                if(newSignedIn)
                {
                    startUserCheck();
                    noteEntranceListener();
                    noteExitListener();
                }
                
                signedIn = newSignedIn;
            });
            
            if(window.authorization.currentUser != undefined)
            {
                startUserCheck();
                noteEntranceListener();
                noteExitListener();
            }
        }
    }
};

var MathHelper = 
{
    "forceParseInt": function(stringValue)
    {
        if(stringValue === undefined)
        {
            return 0;
        }
        
        if(!(typeof stringValue === "string") || stringValue.length === 0)
        {
            return 0;
        }
        
        var outputString = "";
        var currentCharacter;
        
        for(var i = 0; i < stringValue.length; i++)
        {
            currentCharacter = stringValue.charAt(i);
            
            if(currentCharacter >= '0' && currentCharacter <= '9')
            {
                outputString += currentCharacter;
            }
            else if(currentCharacter == '.')
            {
                break;
            }
        }
        
        if(outputString === '')
        {
            outputString = "0";
        }
        
        if(stringValue.charAt(0) == '-')
        {
            outputString = '-' + outputString;
        }
        
        return parseInt(outputString);
    },
    "forceParseFloat": function(stringValue)
    {
        if(stringValue === undefined)
        {
            return 0;
        }
        
        if(!(typeof stringValue === "string") || stringValue.length === 0)
        {
            return 0;
        }
        
        var outputString = "";
        var currentCharacter;
        var addedPoint = false;
        
        for(var i = 0; i < stringValue.length; i++)
        {
            currentCharacter = stringValue.charAt(i);
            
            if(currentCharacter >= '0' && currentCharacter <= '9')
            {
                outputString += currentCharacter;
            }
            else if(currentCharacter == '.' && !addedPoint)
            {
                outputString += ".";
                addedPoint = true;
            }
        }
        
        if(outputString === '')
        {
            outputString = "0";
        }
        
        if(stringValue.charAt(0) == '-')
        {
            outputString = '-' + outputString;
        }
        
        return parseFloat(outputString);
    },
    "getNumberValue": function(character)
    {
        var result = "";
        
        if(character >= '0' && character <= '9')
        {
            result = parseInt(character);
        }
        else
        {
            result = character.charCodeAt(0) - 'a'.charCodeAt(0) + 10;
        }
        
        return result;
    },
    "parseHex": function(hexString)
    {
        var result = 0;
        var power = 0;
        
        for(var i = hexString.length - 1; i >= 0; i--)
        {
            var digit = MathHelper.getNumberValue(hexString.charAt(i));
            result += Math.pow(16, power) * digit;
            
            power++;
        }
        
        return result;
    }
};

var JSHelper =
{
    "combineMaps": function(map1, map2)
    {
        var result = {};
        
        for(var i in map1)
        {
            result[i] = map1[i];
        }
        
        for(var i in map2)
        {
            result[i] = map2[i];
        }
        
        return result;
    }, // A random integer from a up to and including b.
    "randInt": function(a, b)
    {
        return Math.floor(Math.random() * (b - a + 1) + a);
    },
    "colorStringToArray": function(colorData)
    {
        var color = [0, 0, 0, 0.0];
        
        if(colorData.substring(0, "rgba(".length) === "rgba(" && colorData.length > "rgba(".length)
        {
            colorData = colorData.substring("rgba(".length, colorData.length - 1);
            
            var sections = colorData.split(",");
            
            if(sections.length === 4)
            {
                for(var i = 0; i < sections.length && i < color.length; i++)
                {
                    color[i] = MathHelper.forceParseFloat(sections[i]);
                }
            }
        }
        else if(colorData.length > 0 && colorData.charAt(0) === "#")
        {
            if(colorData.length === 6)
            {
                var red = MathHelper.parseHex(colorData.substring(0, 2));
                var green = MathHelper.parseHex(colorData.substring(2, 4));
                var blue = MathHelper.parseHex(colorData.substring(4, 6));
                
                color[0] = red;
                color[1] = green;
                color[2] = blue;
                color[3] = 1.0;
            }
        }
    
        return color;
    }
};

var HTMLHelper =
{
    "textToHTML": function(text)
    {
        text = text || "";
    
        var result = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br/>").replace(/  /g, " &nbsp;");
        
        return result;
    },
    "formattedTextToHTML": function(text)
    {
        var result = "";
        
        var inParagraph = false,
            inHeader = false;
            
        var lastCharacter = undefined;
        
        var currentCharacter = '';
        for(var i = 0; i < text.length; i++)
        {
            currentCharacter = text.charAt(i);
            
            switch(currentCharacter)
            {
                case '<':
                    result += "&lt;";
                    break;
                case '>':
                    result += "&gt;";
                    break;
                case '\n':
                    if(inParagraph)
                    {
                        result += "</p>";
                    }
                    
                    inParagraph = true;
                
                    result += "<p>";
                    break;
                case '_':
                    if(inHeader)
                    {
                        result += "</h2>";
                        
                        inHeader = false;
                    }
                    else if(lastCharacter && (lastCharacter === " " || lastCharacter === "\n") || lastCharacter === undefined)
                    {
                        inHeader = true;
                
                        result += "<h2>";
                    }
                    else
                    {
                        result += "_";
                    }
                    break;
                case '&':
                    result += "&amp;";
                    break;
                default:
                    result += currentCharacter;
            }

            
            lastCharacter = currentCharacter;
        }
        
        if(inParagraph)
        {
            result += "</p>";
        }
                    
        if(inHeader)
        {
            result += "</h2>";
        }
        
        return result;
    },
    "drawDashedLine": function(ctx, x1, y1, x2, y2, dashLength)
    {
        var dashCount = Math.floor(Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)) / dashLength);
        
        var x = x1,
            y = y1;
            
        var nextX, nextY;
        
        var deltaX = (x2 - x1) / dashCount;
        var deltaY = (y2 - y1) / dashCount;
        
        dashOn = true;
        for(var i = 0; i < dashCount; i++)
        {
            nextX += deltaX;
            nextY += deltaY;
            
            if(dashOn)
            {
                ctx.moveTo(x, y);
                ctx.lineTo(nextX, nextY);
            }
            
            dashOn = !dashOn;
            
            x = nextX;
            y = nextY;
        }
    },
    "addLineBreak": function(element)
    {
        element.appendChild(document.createElement("br"));
    },
    "addHR": function(element)
    {
        element.appendChild(document.createElement("hr"));
    },
    "addLabel": function(text, parentElement, tagName)
    {
        var labelElement = document.createElement(tagName || "span");
        labelElement.innerHTML = text;
        
        parentElement.appendChild(labelElement);
        
        return labelElement;
    },
    "addButton": function(text, command, parentElement, submitOnEnter)
    {
        var buttonElement = document.createElement("button");
        buttonElement.innerHTML = text;
        
        buttonElement.onclick = function()
        {
            command.apply(this, arguments);
        };
        
        var addEnterListener = function(element)
        {
            element.addEventListener("keyup", function(event)
            {
                if(event.keyCode == 13)
                {
                    command.apply(this, arguments);
                }
            });
        };
        
        if(submitOnEnter)
        {
            for(var i in submitOnEnter)
            {
                addEnterListener(submitOnEnter[i]);
            }
        }
        
        parentElement.appendChild(buttonElement);
        
        return buttonElement;
    },
    "addSlider": function(minimum, maximum, step, parentElement, value)
    {
        var input = HTMLHelper.addInput("", value || 0, parentElement, "range");
        input.min = minimum;
        input.max = maximum;
        input.step = step || 0.1;
        
        return input;
    },
    "addInput": function(placeHolder, value, parentElement, type)
    {
        var tagName = "input";
        
        if(type === "textarea")
        {
            tagName = "textarea";
        }
        
        var inputElement = document.createElement(tagName);
        
        inputElement.value = value || "";
        inputElement.setAttribute("placeholder", placeHolder || "");
        inputElement.type = type || "text";
        
        parentElement.appendChild(inputElement);
        
        return inputElement;
    },
    "addBoundedInput": function(placeHolder, value, maxLength, parentElement, type, checkLengthStorage)
    {
        var tagName = "input";
        
        if(type === "textarea")
        {
            tagName = "textarea";
        }
        
        checkLengthStorage = checkLengthStorage || {};
        
        var containerElement = document.createElement("span");
        var inputElement = document.createElement(tagName);
        var errorDescription = document.createElement("span");
        
        inputElement.setAttribute("class", "boundedInputOk");
        errorDescription.setAttribute("class", "errorDescription");
        
        inputElement.value = value || "";
        inputElement.setAttribute("placeholder", placeHolder || "");
        inputElement.type = type || "text";
        
        var checkLength = function()
        {
            if(inputElement.value.length > maxLength)
            {
                inputElement.setAttribute("class", "boundedInputOversize");
                errorDescription.innerHTML = (inputElement.value.length - maxLength) + " too many characters.";
            }
            else
            {
                inputElement.setAttribute("class", "boundedInputOk");
                errorDescription.innerHTML = "";
            }
        };
        
        inputElement.addEventListener("keypress", function()
        {
            checkLength();
        });
        
        inputElement.addEventListener("change", function()
        {
            checkLength();
        });
        
        inputElement.addEventListener("input", function()
        {
            checkLength();
        });
        
        checkLengthStorage.checkLength = checkLength;
        
        containerElement.appendChild(inputElement);
        containerElement.appendChild(errorDescription);
        parentElement.appendChild(containerElement);
        
        return inputElement;
    },
    "transitionProperty": function(setValueFunction, start, stop, duration, onComplete, doRound, suffix)
    {
        suffix = suffix || 0;
        duration = duration || 100;
        onComplete = onComplete || function() {};
        
        var slope = (stop - start) / (duration);
        var lastTime = (new Date()).getTime();
        var value = start;
        
        setValueFunction(value);
        
        function animate()
        {
            var nowTime = (new Date()).getTime();
            var deltaT = nowTime - lastTime;
            
            value += slope * deltaT;
            
            setValueFunction((!doRound ? value : Math.floor(value)) + suffix);
            
            lastTime = nowTime;
            
            if(value > stop && slope < 0 || value < stop && slope > 0)
            {
                requestAnimationFrame(animate);
            }
            else
            {
                onComplete();
            }
        }
        animate();
    },
    "eventArgumentToXY": function(handle, preventDefault)
    {
        return function(event)
        {
            if(preventDefault)
            {
                event.preventDefault();
            }
            
            handle(event.clientX, event.clientY);
        };
    },
    "eventArgumentToElementXY": function(event, element)
    {
        var bbox = element.getBoundingClientRect();
        
        var result = { 'x': null, 'y': null };
        
        result.x = event.clientX - bbox.left;
        result.y = event.clientY - bbox.top;
        
        return result;
    },
    "commandMapToButtons": function(commandMap)
    {
        var result = document.createElement("div");
        
        var createButton = function(key)
        {
            HTMLHelper.addButton(key, function()
            {
                commandMap[key].apply(this, arguments);
            }, result);
        };
        
        for(var key in commandMap)
        {
            createButton(key);
        }
        
        return result;
    },
    "chainOldAndNew": function(oldFunction, newFunction, setOldFunction)
    {
        var secondaryRefrenceToOld = oldFunction || function() {};
        
        setOldFunction(function()
        {
            secondaryRefrenceToOld.apply(this, arguments);
            return newFunction.apply(this, arguments);
        });
    },
    "normalizeZIndiciesAndGetMax": function(array, minZIndex)
    {
        if(array.length === 0)
        {
            return;
        }
        
        array.sort(function(a, b)
        {
            return a.getZIndex() - b.getZIndex();
        });
        
        var lastZIndex = minZIndex;
        var currentZIndex;
        for(var index = 0; index < array.length; index++)
        {
            currentZIndex = array[index].getZIndex();
            
            if(currentZIndex <= lastZIndex)
            {
                array[index].setZIndex(lastZIndex + 1);
                currentZIndex = lastZIndex + 1;
            }
            
            lastZIndex = currentZIndex;
        }
        
        var maxZIndex = array[array.length - 1].getZIndex();
        
        return maxZIndex;
    },
    "unZoomDocument": function(unlockZoom)
    {
        var viewPortMeta = document.getElementById("viewPort");
        
        if(!viewPortMeta)
        {
            viewPortMeta = document.createElement("meta");
            viewPortMeta.setAttribute("name", "viewport");
            
            document.body.parentElement.appendChild(viewPortMeta);
        }
        
        viewPortMeta.setAttribute("content", "width = device-width, maximum-scale=1.0, minumum-scale=1.0");
        
        if(unlockZoom)
        {
            requestAnimationFrame(function()
            {
                viewPortMeta.setAttribute("content", "width = device-width, maximum-scale=10.0, minumum-scale=1.0");
            });
        }
    }
};

var SubWindowHelper = 
{
    "draggableDisplay": null,
    "windowList": {},
    "windowCount": 0,
    "getDraggableDisplay": function()
    {
        if(!SubWindowHelper.draggableDisplay)
        {
            SubWindowHelper.draggableDisplay = document.createElement("div");
            SubWindowHelper.draggableDisplay.setAttribute("class", "draggableHelper");
            SubWindowHelper.draggableDisplay.style.display = "none";
            document.body.appendChild(SubWindowHelper.draggableDisplay);
        }
        
        return SubWindowHelper.draggableDisplay;
    },
    "create": function(options)
    {
        var result = new Window(document.body,
            SubWindowHelper.windowList, SubWindowHelper.windowCount, options);
        
        SubWindowHelper.windowCount++;
        
        return result;
    },
    "alert": function(title, text, onSubmit, windowOptions, okLabel)
    {
        onSubmit = onSubmit || function() {};
        windowOptions = windowOptions || {};
        windowOptions.width = windowOptions.width || "auto";
        windowOptions.height = windowOptions.height || "auto";
        windowOptions.resizable = windowOptions.resizable || false;
        windowOptions.XButton = windowOptions.XButton || false;
        windowOptions.maxWidth = windowOptions.maxWidth || "50%";
        windowOptions.title = title || windowOptions.title || "Confirm";
        
        var newWindow = SubWindowHelper.create(windowOptions);
        
        var dialogueContent = document.createElement("span");
        
        HTMLHelper.addLabel(text, dialogueContent, "div");
        
        HTMLHelper.addButton(okLabel || "Ok", function()
        {
            onSubmit(true);
            newWindow.close();
        }, dialogueContent);
        
        newWindow.appendChild(dialogueContent);
        
        return newWindow;
    },
    "confirm": function(title, text, onSubmit, windowOptions, okLabel, cancelLabel)
    {
        onSubmit = onSubmit || function() {};
        windowOptions = windowOptions || {};
        windowOptions.XButton = windowOptions.XButton || false;
        var newWindow = SubWindowHelper.alert.apply(this, arguments);
        
        HTMLHelper.addButton(cancelLabel || "Cancel", function()
        {
            onSubmit(false);
            newWindow.close();
        }, newWindow.getContent());
        
        return newWindow;
    },
    "prompt": function(title, text, placeHolder, onSubmit, inputType, windowOptions)
    {
        onSubmit = onSubmit || function() {};
        windowOptions = windowOptions || {};
        windowOptions.width = windowOptions.width || "auto";
        windowOptions.height = windowOptions.height || "auto";
        windowOptions.maxWidth = windowOptions.maxWidth || "50%";
        windowOptions.resizable = windowOptions.resizable || false;
        windowOptions.title = title || windowOptions.title || "Confirm";
        
        var newWindow = SubWindowHelper.create(windowOptions);
        
        var dialogueContent = document.createElement("span");
        
        HTMLHelper.addLabel(text, dialogueContent, "div");
        var responseInput = HTMLHelper.addInput(placeHolder, "", dialogueContent, inputType);
        
        HTMLHelper.addButton("Ok", function()
        {
            onSubmit(responseInput.value);
            newWindow.close();
        }, dialogueContent, [responseInput]);
        
        newWindow.appendChild(dialogueContent);
        
        return newWindow;
    },
    "multiInputPrompt": function(title, text, inputPlaceholders, inputTypes, onSubmit, windowOptions)
    {
        onSubmit = onSubmit || function() {};
        windowOptions = windowOptions || {};
        windowOptions.width = windowOptions.width || "auto";
        windowOptions.height = windowOptions.height || "auto";
        windowOptions.resizable = windowOptions.resizable || false;
        windowOptions.title = title || windowOptions.title || "Confirm";
        windowOptions.maxWidth = windowOptions.maxWidth || "50%";
        
        var newWindow = SubWindowHelper.create(windowOptions);
        
        var dialogueContent = document.createElement("span");
        
        HTMLHelper.addLabel(text, dialogueContent, "div");
        var responseInputs = [];
        
        var placeHolder, inputType;
        for(var index = 0; index < inputTypes.length 
                && index < inputPlaceholders.length; index++)
        {
            placeHolder = inputPlaceholders[index];
            inputType = inputTypes[index];
            
            responseInputs.push(HTMLHelper.addInput(placeHolder, "", dialogueContent, inputType));
        }
        
        HTMLHelper.addButton("Ok", function()
        {
            var values = [];
            for(var index = 0; index < responseInputs.length; index++)
            {
                values.push(responseInputs[index].value);
            }
            
            onSubmit(values);
            newWindow.close();
        }, dialogueContent, responseInputs);
        
        newWindow.appendChild(dialogueContent);
        
        return newWindow;
    },
    "promptForColor": function(title, description, defaultRGBA, onComplete, windowOptions)
    {
        color = defaultRGBA || [0, 0, 0, 0.0];
        
        while(color.length < 4)
        {
            color.push(0);
        }
        
        windowOptions = windowOptions || {};
        windowOptions.width = windowOptions.width || "auto";
        windowOptions.height = windowOptions.height || "auto";
        windowOptions.resizable = windowOptions.resizable || false;
        windowOptions.title = title || windowOptions.title || "Confirm";
        windowOptions.maxWidth = windowOptions.maxWidth || "50%";
        
        var newWindow = SubWindowHelper.create(windowOptions);
        
        var dialogueContent = document.createElement("span");
        
        HTMLHelper.addLabel(description, dialogueContent, "div");
        
        var sliders = [];
        
        for(var i = 0; i < 3; i++)
        {
            sliders.push(HTMLHelper.addSlider(0, 256, 1, dialogueContent));
        }
        sliders.push(HTMLHelper.addSlider(0, 1.0, 0.1, dialogueContent));
        
        var handleSlider = function(sliderIndex)
        {
            if(sliderIndex >= color.length || sliderIndex >= sliders.length)
            {
                return;
            }
            
            var updateColorFromSlider = function()
            {
                color[sliderIndex] = sliders[sliderIndex].value;
                
                updateSliders();
                updateInput();
                updateWindow();
            };
            
            sliders[sliderIndex].onchange = updateColorFromSlider;
            sliders[sliderIndex].oninput = updateColorFromSlider;
        };
        
        for(var i = 0; i < sliders.length; i++)
        {
            handleSlider(i);
        }
        
        var updateSliders = function()
        {
            for(var i = 0; i < sliders.length && i < color.length; i++)
            {
                sliders[i].value = color[i];
                sliders[i].style.backgroundColor = "rgba(" + color.join(",") + ")";
            }
        };
        
        var textInput = HTMLHelper.addInput("Color", "rgba(" + color.join(',') + ")", dialogueContent);
        
        var updateColorFromTextInput = function()
        {
            var colorData = textInput.value;
            
            if(colorData.substring(0, "rgba(".length) === "rgba(" && colorData.length > "rgba(".length)
            {
                colorData = colorData.substring("rgba(".length, colorData.length - 1);
                
                var sections = colorData.split(",");
                
                if(sections.length === 4)
                {
                    for(var i = 0; i < sections.length && i < color.length; i++)
                    {
                        color[i] = MathHelper.forceParseFloat(sections[i]);
                    }
                    
                    updateSliders();
                    updateInput();
                    updateWindow();
                }
            }
            else if(colorData.length > 0 && colorData.charAt(0) === "#")
            {
                colorData = colorData.substring(1, colorData.length);
                if(colorData.length === 6)
                {
                    var red = MathHelper.parseHex(colorData.substring(0, 2));
                    var green = MathHelper.parseHex(colorData.substring(2, 4));
                    var blue = MathHelper.parseHex(colorData.substring(4, 6));
                    
                    color[0] = red;
                    color[1] = green;
                    color[2] = blue;
                    
                    updateSliders();
                    updateInput();
                    updateWindow();
                }
            }
        };
        
        textInput.oninput = updateColorFromTextInput;
        textInput.onchange = updateColorFromTextInput;
        
        var updateInput = function()
        {
            textInput.value = "rgba(" + color.join(',') + ")";
            textInput.style.boxShadow = "3px 3px 10px " + textInput.value;
        };
        
        var updateWindow = function()
        {
            newWindow.getContent().style.backgroundColor = textInput.value;
        }
        
        updateInput();
        updateSliders();
        updateWindow();
        
        newWindow.element.style.backgroundImage = "radial-gradient(black, white)";
        newWindow.element.style.backgroundSize = "5px 5px";
        
        HTMLHelper.addButton("Ok", function()
        {
            onComplete.apply(this, color);
            
            newWindow.close();
        }, dialogueContent, [textInput]);
        
        newWindow.appendChild(dialogueContent);
        
        return newWindow;
    }
};

var ClientStorageHelper =
{
    "setCookie": function(name, value, expiration)
    {
        if(!expiration)
        {
            expiration = new Date();
            expiration.setUTCFullYear(expiration.getUTCFullYear() + 2);
        }
        
        document.cookie = name + "=" + value + "; expires=" + expiration.toUTCString() + "; path=/;";
    },
    
    "getCookie": function(findName)
    {
        var cookiesString = document.cookie;
        
        var cookies = cookiesString.split("; ");
        var currentName, value;
        var currentCookie;
        var equalsLocation;
        
        for(var cookieIndex = 0; cookieIndex < cookies.length; cookieIndex++)
        {
            currentCookie = cookies[cookieIndex];
            
            equalsLocation = currentCookie.indexOf("=");
            
            if(equalsLocation >= 0)
            {
                currentName = currentCookie.substring(0, equalsLocation);
                value = currentCookie.substring(equalsLocation + 1, currentCookie.length);
                
                if(findName === currentName)
                {
                    return value;
                }
            }
        }
        
        // Return undefined if no cookies found.
        return undefined;
    },
    
    "clearCookie": function(name)
    {
        var expirationDate = new Date();
        
        expirationDate.setUTCFullYear(2000);
        expirationDate.setUTCMonth(1);
        
        document.cookie = name + "=; exipres=" + (expirationDate.toUTCString()) + "; path=/;";
    },
    
    "storeInformation": function(key, value)
    {
        if(window.localStorage)
        {
            localStorage.setItem(key, value);
        }
        else
        {
            ClientStorageHelper.setCookie(key, value);
        }
    },
    
    "getInformation": function(key)
    {
        if(window.localStorage)
        {
            return localStorage.getItem(key);
        }
        else
        {
            return ClientStorageHelper.getCookie(key);
        }
    },
    
    
    
    "imageToDataURL": function(image, onComplete, rescaleFactor)
    {
        rescaleFactor = rescaleFactor || 1;
        var canvas = document.createElement("canvas");
        canvas.width = image.width * rescaleFactor;
        canvas.height = image.height * rescaleFactor;
        
        var ctx = canvas.getContext("2d");
        
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
        
        requestAnimationFrame(function()
        {
            onComplete(canvas.toDataURL("image/png"));
        });
    },
    
    "storeImage": function(key, image, resize)
    {
        ClientStorageHelper.imageToDataURL(image, function(url)
        {
            console.log(url);
            
            ClientStorageHelper.storeInformation(key, url);
            ClientStorageHelper.storeInformation(key + "SIZE", image.width + "," + image.height);
        }, resize || 0.7);
    },
    
    "getImageSize": function(key)
    {
        var sizeData = ClientStorageHelper.getInformation(key + "SIZE");
        
        if(!sizeData)
        {
            return null;
        }
        
        var widthHeightTuple = sizeData.split(",");
        
        if(widthHeightTuple.length <= 1)
        {
            return null;
        }
        
        var width = MathHelper.forceParseFloat(widthHeightTuple[0]);
        var height = MathHelper.forceParseFloat(widthHeightTuple[1]);
        
        return {"width": width, "height": height};
    }
};

var CommunicationHelper = {};
CommunicationHelper["ChatMessage"] = function(user, content, timeReceived, uid)
{
    this.user = user;
    this.content = content;
    this.timeReceived = timeReceived || (new Date()).getTime();
    this.uid = uid || "NONE";
    this.type = "message";
};

CommunicationHelper["ErrorMessage"] = function(content, timeReceived)
{
    this.user = "Game";
    this.content = content;
    this.timeReceived = timeReceived || (new Date()).getTime();
    this.uid = "GAME";
    this.type = "error";
};

CommunicationHelper["ResourceListener"] = function(resourceLocation, listenerType)
{
    this.resource = database.ref(resourceLocation);
    this.listeners = {};
    this.lastListenerId = 0;
    this.listenerRunning = false;
    
    var me = this;
    this.postToListeners = function(json, data)
    {
        for(var i in me.listeners)
        {
            try
            {
                me.listeners[i](json, data);
            }
            catch(error)
            {
                console.error(error);
            }
        }
    };
    
    this.startListener = function()
    {
        if(!me.listenerRunning)
        {
            me.listenerRunning = true;
            
            me.resource.on(listenerType, function(data)
            {
                var json = data.val();
                
                me.postToListeners(json, data);
            }, function()
            {
                console.warn("Listener on " + listenerType + " has stopped.");
                me.listenerRunning = false;
            });
        }
    };
    
    this.addListener = function(listener)
    {
        if(!me.listenerRunning)
        {
            me.startListener();
        }
        
        me.lastListenerId++;
        
        me.listeners[me.lastListenerId + ""] = listener;
        
        return me.lastListenerId;
    };
    
    this.removeListener = function(listenerId)
    {
        delete me.listeners[me.listenerId + ""];
    };  
};

CommunicationHelper["maxMessageLength"] = 2524;
    
CommunicationHelper = JSHelper.combineMaps(
CommunicationHelper, 
{
    "chatListenerId": 0,
    "chatMessages": [new CommunicationHelper.ChatMessage("The Game", "This is the chat window for this game. Chat messages may not contain over " + CommunicationHelper.maxMessageLength + " characters. If you need a permanent or lasting copy of this chat history, that is your responsibility.", (new Date()).getTime())],
    "resources": {},
    "resourceNames": {BACKGROUND_SRC: "gameData/background/src", BACKGROUND_SCALE: "gameData/background/scale", BACKGROUND_ROTATE: "gameData/background/rotate", WORLD_BACKGROUND_COLOR: "gameData/world3DMap/backgroundColor", WORLD_BACKGROUND_CUBE_COUNT: "gameData/world3DMap/backgroundCubeCount", WORLD_BACKGROUND_TIME_DIVIDER: "gameData/world3DMap/backgroundCubeTimeDivider", WORLD_SHARED_IMAGE: "gameData/world3DMap/sharedCubeImage", WORLD_SHARED_IMAGE_UPDATE: "gameData/world3DMap/sharedCubeImageUpdate", WORLD_PLAYER_POSITION: "gameData/world3DMap/lastPlayerMove" },
    
    "listenOnce": function(resourceLocation, listener)
    {
        database.ref(resourceLocation).once("value", function(data)
        {
            listener(data.val(), data.key);
        }).catch(function(error)
        {
            SubWindowHelper.alert("ListenOnce Error", error.message || error);
        });
    },
    
    "setData": function(resourceLocation, setTo, then)
    {
        database.ref(resourceLocation).set(setTo).then(
        then || function()
        {
        
        }).catch(function(error)
        {
            SubWindowHelper.alert("Data Set Error", "Error setting " + resourceName + " to " + setTo + ". Error: " + (error.message || error));
        });
    },
    
    "addResourceListener": function(resourceName, listener, type)
    {
        type = type || "value";
        var hashKey = resourceName + type;
        
        if(!CommunicationHelper.resources[hashKey])
        {
            CommunicationHelper.resources[hashKey] = new CommunicationHelper.ResourceListener(resourceName, type);
        }
        
        var listenerId = CommunicationHelper.resources[hashKey].addListener(listener);
        
        return listenerId;
    },
    "startClosedListeners": function()
    {
        for(var i in CommunicationHelper.resources)
        {
            CommunicationHelper.resources[i].startListener();
        }
    },
    "getImage": function(path, onComplete)
    {
        console.log("Get image: " + path);
        if(!path)
        {
            console.log("No path.");
            return false;
        }
        
        console.log("9");
        if(path.indexOf("http://") === 0 || path.indexOf("https://") === 0)
        {
            var image = new Image();
            image.src = path;
            image.crossOrigin = "";
            
            try
            {
                onComplete(path, image);
            }
            catch(e)
            {
                console.error("ERROR ONCOMPLETE: " + e);
            }
            
            return true;
        }
        else if(path.indexOf("dw-") === 0)
        {
            var canvas = document.createElement("canvas");
            canvas.width = 100;
            canvas.height = 100;
            
            var ctx = canvas.getContext("2d");
            
            var renderer = new DrawingDisplay(path);
            
            var size = renderer.render(ctx);
            
            if(size.width > canvas.width || size.height > canvas.height)
            {
                canvas.width = size.width;
                canvas.height = size.height;
                
                ctx = canvas.getContext("2d");
                
                renderer.render(ctx);
            }
            
            onComplete(canvas.toDataURL("image/png"), canvas);
            return true;
        }
        console.log("1");
        
        
        var storageKey = path.split("/").join("_Slash_");
        var storageURL = ClientStorageHelper.getInformation(storageKey);
        var imageSize = ClientStorageHelper.getImageSize(storageKey);
        
        console.log("2");
        
        if(storageURL)
        {
            console.log("From client storage...");
            var image = new Image();
            image.src = storageURL;
            image.crossOrigin = "";
            
            if(imageSize)
            {
                image.width = imageSize.width;
                image.height = imageSize.height;
            }
            else
            {
                image.addEventListener("load", function()
                {
                    ClientStorageHelper.storeImage(storageKey, image, 1);
                    console.log("LINE 1272");
                });
            }
            
            onComplete(storageURL, image);
            
            return true;
        }
        
        
        console.log("3");
        
        console.log(storageURL);
        storageRef.child(path).getDownloadURL().then(function(url)
        {
            var request = new XMLHttpRequest();
            request.responseType = "blob";
            request.onload = function()
            {
                var blobData = request.response;
                var url = (window.URL || window.webkitURL).createObjectURL(blobData);
            
                console.log("LINE 1262");
                var image = new Image();
                image.src = url;
                image.crossOrigin = "";
                
                
                console.log("LINE 1267");
                
                image.addEventListener("load", function()
                {
                    ClientStorageHelper.storeImage(storageKey, image);
                    console.log("LINE 1272");
                });
                
                onComplete(url, image);
            };

            console.log("Error? 2");            
            request.open("GET", url);
            console.log("Error?");
            request.send();
            console.log("Done!");
        }).catch(function(error)
        {
            SubWindowHelper.alert("Error!", "Error in getImage: " + error + ".");
            onComplete(null, null);
        });
        return true;
    },
    "startChatListenerIfNotRunning": function(listenOn)
    {
        listenOn = listenOn || "lastChat";
        if(!CommunicationHelper["chatListener" + listenOn + "Running"])
        {
            if(!CommunicationHelper["chatMessages" + listenOn])
            {
                CommunicationHelper["chatMessages" + listenOn] = [];
                CommunicationHelper["chatMessages" + listenOn] = CommunicationHelper["chatMessages" + listenOn].concat(CommunicationHelper["chatMessages"]);
            }
            
            if(!CommunicationHelper["chatListeners" + listenOn])
            {
                CommunicationHelper["chatListeners" + listenOn] = {};
            }
        
            if(!CommunicationHelper["iteratingListeners" + listenOn])
            {
                CommunicationHelper["iteratingListeners" + listenOn] = 0;
            }
        
            CommunicationHelper["chatListener" + listenOn + "Running"] = true;
            
            try
            {
                var lastJSON = undefined;
                gameData.child(listenOn).child("id").on("value", function(uidData)
                {
                    console.log(uidData);
                    gameData.child(listenOn).once("value", function(data)
                    {
                        CommunicationHelper["chatListener" + listenOn + "Running"] = true;
                        
                        var json = data.val();
                        
                        if(json !== null && json !== lastJSON)
                        {
                            lastJSON = json;
                            var message = new CommunicationHelper.ChatMessage(json.user, json.content, undefined, json.uid);
                            CommunicationHelper["chatMessages" + listenOn].push(message);
                            
                            CommunicationHelper["iteratingListeners" + listenOn]++;
                            for(var i in CommunicationHelper["chatListeners" + listenOn])
                            {
                                try
                                {
                                    CommunicationHelper["chatListeners" + listenOn][i](message, CommunicationHelper["chatMessages" + listenOn]);
                                }
                                catch(error)
                                {
                                    SubWindowHelper.alert("Error in Listener " + i, "Error: " + error);
                                }
                            }
                            CommunicationHelper["iteratingListeners" + listenOn]--;
                        }
                    }).catch(function(error)
                    {
                        console.warn(error);
                    });
                }, function()
                {
                    CommunicationHelper["chatListener" + listenOn + "Running"] = false;
                    console.warn("END.");
                    
                    CommunicationHelper.startChatListenerIfNotRunning(listenOn);
                });
            }
            catch(error)
            {
                console.warn(error);
                CommunicationHelper["chatListener" + listenOn + "Running"] = false;
                
                var message = new CommunicationHelper.ErrorMessage("Error!\n" + error);
                CommunicationHelper["chatMessages" + listenOn].push(message);
                
                console.warn(CommunicationHelper["chatListeners" + listenOn]);
                
                for(var i in CommunicationHelper["chatListeners" + listenOn])
                {
                    try
                    {
                        CommunicationHelper["chatListeners" + listenOn][i](message, CommunicationHelper["chatMessages" + listenOn]);
                    }
                    catch(error)
                    {
                        SubWindowHelper.alert("Error Sending Information to Listeners", "Error: " + error);
                    }
                }
                
                SubWindowHelper.alert("Error Starting Chat Listener", "Error: " + error);
            }
        }
    }, // Starts the chat listener if necessary.
    "addChatListener": function(listener, listenOn)
    {
        listenOn = listenOn || "lastChat";
        
        if(!CommunicationHelper["chatListener" + listenOn + "Running"])
        {
            CommunicationHelper.startChatListenerIfNotRunning(listenOn);
        }
        
        if(!CommunicationHelper["chatListeners" + listenOn])
        {
            CommunicationHelper["chatListeners" + listenOn] = {};
        }
    
        CommunicationHelper.chatListenerId++;
        
        var addListener;
        addListener = function()
        {
            if(CommunicationHelper["iteratingListeners" + listenOn] === 0)
            {
                CommunicationHelper["chatListeners" + listenOn][CommunicationHelper.chatListenerId] = listener;
            }
            else
            {
                setTimeout(function()
                {
                    console.log("Waiting...");
                    addListener();
                }, 100);
            }
        };
        
        addListener();
        
        return CommunicationHelper.chatListenerId;
    },
    "removeChatListener": function(id, listenOn)
    {
        listenOn = listenOn || "lastChat";
        
        var removeListener;
        removeListener = function()
        {
            if(CommunicationHelper["iteratingListeners" + listenOn] === 0)
            {
                delete CommunicationHelper["chatListeners" + listenOn][id];
            }
            else
            {
                setTimeout(function()
                {
                    console.log("Waiting...");
                    removeListener();
                }, 100);
            }
        };
        
        removeListener();
    },
    "processContent": function(content)
    {
        var result = content;
        
        var rollLocation = content.search("%roll ");
        if(rollLocation === 0)
        {
            var words = content.split(" ");
            if(words.length > 1)
            {
                var rollDescriptor = words[1].split("d");
                if(rollDescriptor.length > 1)
                {
                    var diceCount = MathHelper.forceParseInt(rollDescriptor[0]);
                    var rollTo = MathHelper.forceParseInt(rollDescriptor[1]);
                    
                    var count = 0;
                    var currentValue = 0;
                    var rolls = "";
                    for(var i = 0; i < diceCount; i++)
                    {
                        currentValue = JSHelper.randInt(1, rollTo);
                        count += currentValue;
                        rolls += currentValue;
                        
                        if(i + 1 < diceCount)
                        {
                            rolls += "+";
                        }
                    }
                    
                    result += "\r\nRolling " + diceCount + "d" + rollTo + "... \r\n SUM: " + count + "\r\n = " + rolls;
                }
            }
        }
        
        return result;
    },
    "getChatMessages": function(chatName)
    {
        chatName = chatName || "lastChat";
        
        if(CommunicationHelper["chatMessages" + chatName] === undefined || CommunicationHelper["chatMessages" + chatName].length === 0)
        {
            console.warn("Creating messages.");
            CommunicationHelper["chatMessages" + chatName] = [];
            
            for(var i in CommunicationHelper.chatMessages)
            {
                CommunicationHelper["chatMessages" + chatName].push(CommunicationHelper.chatMessages[i]);
            }
        }
        
        return CommunicationHelper["chatMessages" + chatName];
    },
    "launchChatWindow": function(directToGM)
    {
        var postTo = "";
        if(!directToGM)
        {
            postTo = "lastChat";
        }
        else
        {
            postTo = "lastToGMChat";
        }
        
        var windowTitle = "Chat Area";
        
        if(directToGM)
        {
            windowTitle += " -- To GM";
        }
        
        var chatListenerId;
        var chatWindow = SubWindowHelper.create({"title": windowTitle, "width": "30%", "height": "20%", "x": "68%", "y": "77%", "classPrefix": "chatArea", "onClose": function()
        {
            CommunicationHelper.removeChatListener(chatListenerId, postTo);
        }});
        
        var contentZone = chatWindow.getContent();
        
        var chatContainer = document.createElement("div");
        chatContainer.style.wordWrap = "break-word";
        
        var chatContent = document.createElement("div");
        chatContainer.appendChild(chatContent);
        
        var messageId = 0;
        
        var toInput;
        
        var handleAddedContent = function(message, allMessages)
        {
            var messageContainer = document.createElement("div");
            
            if(messageId % 2 === 0 && message && message.type === "message")
            {
                messageContainer.style.backgroundColor = "rgba(200, 200, 200, 0.5)";
            }
            else if(message && message.type === "error")
            {
                messageContainer.style.backgroundColor = "rgba(255, 100, 150, 0.5)";
            }
            
            messageId ++;
            
            var userDisplay = HTMLHelper.addLabel(HTMLHelper.textToHTML(message.user), messageContainer, "div");
            
            var showingUID = false;
            
            userDisplay.addEventListener("click", function()
            {
                if(showingUID)
                {
                    userDisplay.innerHTML = HTMLHelper.textToHTML(message.user);
                }
                else
                {
                    userDisplay.innerHTML = HTMLHelper.textToHTML(message.uid);
                }    
                
                if(directToGM && toInput)
                {
                    toInput.value = message.uid;
                }
                
                showingUID = !showingUID;
            });
            
            userDisplay.setAttribute("class", "userNameDisplay");
            
            var contentDisplay = HTMLHelper.addLabel(HTMLHelper.textToHTML(message.content), 
                        messageContainer, "div");
            contentDisplay.style.marginLeft = "10px";
            contentDisplay.style.font = "10pt Sans";
            var scrolledToBase = Math.abs(contentZone.scrollTop + contentZone.clientHeight - contentZone.scrollHeight) < 2;
            
            chatContent.appendChild(messageContainer);
            
            requestAnimationFrame(function()
            {
                if(scrolledToBase)
                {
                    contentZone.scrollTop = contentZone.scrollHeight;
                }
            });
        };
        
        chatListenerId = CommunicationHelper.addChatListener(handleAddedContent, postTo);
        
        var messages = CommunicationHelper.getChatMessages(postTo);
        for(var i = 0; i < messages.length; i++)
        {
            handleAddedContent(messages[i], messages);
        }
        
        var postContentZone = document.createElement("div");
        var postInput = HTMLHelper.addBoundedInput("Post Content", "", CommunicationHelper.maxMessageLength, postContentZone, "text");
        
        if(AuthorizationHelper.getHasAccess() && directToGM)
        {
            toInput = HTMLHelper.addInput("UID To", "", postContentZone, "text");
        }
        
        var submitButton = HTMLHelper.addButton("Post", function()
        {
            var content = postInput.value;
            
            content = CommunicationHelper.processContent(content);
            
            var now = new Date();
            
            var newPost = 
            {
                "user": (authorization.currentUser.displayName || authorization.currentUser.email),
                "uid": authorization.getUid(),
                "content": content,
                "id": "" + (new Date().getTime())
            };
            
            if(toInput && directToGM)
            {
                newPost["to"] = toInput.value;
            }
        
            gameData.child(postTo).set(newPost).then(function()
            {
                postInput.value = "";
            }).catch(function(error)
            {
                var details = "";
                if(content.length > CommunicationHelper.maxMessageLength)
                {
                    details += "Your message comtains " + (content.length - CommunicationHelper.maxMessageLength) + " too many characters. ";
                }
                
                if(!authorization.currentUser.emailVerified)
                {
                    details += "Please verify your email. ";
                }
                
                SubWindowHelper.alert("Error Submitting Post!", "Error: " + error.message + ". " + details);
            });
        }, postContentZone, [postInput]);
        
        chatContainer.appendChild(postContentZone);
        
        chatWindow.appendChild(chatContainer);
    }
});

var AuthenticationHelper = 
{
    "reAuthenticate": function(onComplete)
    {
        var signInHelper;
        
        var reAuthenticateWindow = SubWindowHelper.create({"x": 0, "y": 0, "width": "100%", "height": "90%", "title": "Authenticate"});
        
        signInHelper = new SignInManager(function()
        {
            signInHelper.destroy();
            reAuthenticateWindow.destroy();
            
            onComplete();
        }, true, reAuthenticateWindow.getContent());
        
        SubWindowHelper.alert("Authenticate", "Please sign in again.");
   },
   "verifyEmail": function()
   {
       SubWindowHelper.confirm("Verify Email", "Send an email verification request? Your email does not appear to be verified. Without a verified email, shared/communication features will probably not work.", function(response)
        {
            if(response)
            {
                window.authorization.currentUser.sendEmailVerification().then(function()
                {
                    SubWindowHelper.alert("Verify Email", "Request sent!");
                }).catch(function(error)
                {
                    SubWindowHelper.alert("Error Verifying Email", "Error: " + error.message);
                });
            }
        }, undefined, "Yes", "No");
   }
};

var CharacterControl = 
{
    "maxDisplayLength": 500,
    "maxNameLength": 36,
    "maxClassLength": 36,
    "maxCharacters": 35
};

CharacterControl["createEmptyCharacter"] = function(characterCount)
{
    var characterInfo = {};
    
    try
    {
        var user = window.authorization.currentUser;
        var charactersRefrence = users.child(user.uid).child("characters");
        
        
        characterInfo["content"] = 
        {
            index: characterCount,
            position: 
            {
                x: 0,
                y: 0
            },
            scale: 1.0
        };
        
        charactersRefrence.child(characterCount + "").set(characterInfo["content"]).then(function()
        {
            console.log("Character " + characterCount + " has been created.");
        }).catch(function(error)
        {
            var additionalText = "";
            
            if(CharacterControl.maxCharacters <= characterCount)
            {
                additionalText += " You may have exceeded the maximum of " + CharacterControl.maxCharacters + " characters.";
            }
            
            SubWindowHelper.alert("Error Creating Character", error);
        });
        
        characterInfo["characterId"] = characterCount + "";
        
        
        characterCount++;
    }
    catch(error)
    {
        var additionalText = "";
        
        if(CharacterControl.maxCharacters <= characterCount)
        {
            additionalText += " You may have exceeded the maximum of " + CharacterControl.maxCharacters + " characters.";
        }
        
        SubWindowHelper.alert("Error Creating Character", error);
        return;
    }
    
    return characterInfo;
};

CharacterControl["updateCharacter"] = function(userId, characterId, characterData, onDone, realUserId)
{
    var charactersRefrence = users.child(userId).child("characters");
    
    realUserId = realUserId || userId;
    
    charactersRefrence.child(characterId).set(characterData).then(function()
    {
        var saveData = 
        {
            uid: realUserId,
            character: characterData
        };
        
        gameData.child("lastCharacterChange").set(saveData).then(function()
        {
            if(onDone)
            {
                onDone(true);
            }
        }).catch(function(error)
        {
            if(onDone)
            {
                onDone(false, error, "Error updating global information.");
            }
        });
    }).catch(function(error)
    {
        if(onDone)
        {
            onDone(false, error, "Error saving direct child.");
        }
    });
};

CharacterControl["editCharacter"] = function(id, characterData)
{
    var user = window.authorization.currentUser;
    
    if(!user)
    {
        SubWindowHelper.alert("Error", "Please sign in before using this feature.");
        return;
    }
    characterData = characterData || { index: id };
    
    var charactersRefrence = users.child(user.uid).child("characters");
    var display = SubWindowHelper.create({"title": "Edit " + HTMLHelper.textToHTML(characterData.name) + " -- " + id});
    
    var appearancePane = document.createElement("div");
    HTMLHelper.addLabel("Image URL: ", appearancePane, "span");
    
    var checkLengthContainer = {};
    
    var imageSrc = HTMLHelper.addBoundedInput("Image Src", characterData.display, CharacterControl.maxDisplayLength, appearancePane, "text", checkLengthContainer);
    var imageEditor = new DrawingEditor(appearancePane, imageSrc.value, 200, 200);
    
    imageEditor.setSrcChangeListener(function()
    {
        imageSrc.value = imageEditor.src;
        
        checkLengthContainer.checkLength();
    });
    
    imageSrc.oninput = function()
    {
        imageEditor.setSrc(imageSrc.value);
    };
    
    imageSrc.onchange = function()
    {
        imageEditor.setSrc(imageSrc.value);
    };
    
    var detailsPane = document.createElement("div");
    HTMLHelper.addLabel("Name: ", detailsPane, "span");
    var characterNameInput = HTMLHelper.addBoundedInput("Character Name", characterData.name, CharacterControl.maxNameLength, detailsPane, "text");
    HTMLHelper.addLineBreak(detailsPane);
    
    HTMLHelper.addLabel("Level: ", detailsPane, "span");
    var characterLevelInput = HTMLHelper.addInput("Character Level", characterData.level || 0, detailsPane, "text");
    HTMLHelper.addLineBreak(detailsPane);
    
    HTMLHelper.addLabel("Class: ", detailsPane, "span");
    var characterClassInput = HTMLHelper.addBoundedInput("Character Class", characterData.class, CharacterControl.maxClassLength, detailsPane, "text");
    HTMLHelper.addLineBreak(detailsPane);
    
    HTMLHelper.addLabel("HP: ", detailsPane, "span");
    var characterHPInput = HTMLHelper.addInput("Character HP", characterData.hp || 0, detailsPane, "text");
    HTMLHelper.addLineBreak(detailsPane);
    
    HTMLHelper.addLabel("Scale (Size multiplier): ", detailsPane, "span");
    var characterScaleInput = HTMLHelper.addInput("Scale", characterData.scale || 1.0, detailsPane, "text");
    HTMLHelper.addLineBreak(detailsPane);
    
    
    HTMLHelper.addLabel("NPC: ", detailsPane, "span");
    var npcInput = HTMLHelper.addInput("Npc", undefined, detailsPane, "checkbox");
    npcInput.checked = characterData.npc;
    if(!AuthorizationHelper.hasAccess)
    {
        npcInput.style.display = "none";
    }
    
    HTMLHelper.addLineBreak(detailsPane);
    
    
    HTMLHelper.addLabel("Extra Vision Distance: ", detailsPane, "span");
    var extraVisionDistanceInput = HTMLHelper.addInput("Extra Vision Distance", characterData.vision || 0.0, detailsPane, "text");
    
    if(characterData.position)
    {
        HTMLHelper.addLabel("X: " + characterData.position.x + ", Y: " + characterData.position.y, detailsPane, "div");
    }
    
    var tabControl = new TabbedDisplay({"Appearance": appearancePane, "Details": detailsPane}, display.getContent());
    
    var getSaveData = function()
    {
        var newData = Object.assign({}, characterData);
        
        newData.name = characterNameInput.value;
        newData.level = MathHelper.forceParseFloat(characterLevelInput.value);
        newData.class = characterClassInput.value;
        newData.hp = MathHelper.forceParseFloat(characterHPInput.value);
        newData.scale = MathHelper.forceParseFloat(characterScaleInput.value);
        newData.display = imageSrc.value;
        newData.npc = npcInput.checked || false;
        newData.vision = MathHelper.forceParseFloat(extraVisionDistanceInput.value);
        
        return newData;
    };
    
    var saveButton = HTMLHelper.addButton("Save", function()
    {
        var button = this;
        button.setAttribute("class", "pendingButton");
        
        var newData = getSaveData();
        
        var equivalent = true;
        for(var i in newData)
        {
            if(newData[i] !== characterData[i])
            {
                equivalent = false;
                break;
            }
        }
        
        if(equivalent)
        {
            SubWindowHelper.alert("!", "There were no changes to make.");
            button.setAttribute("class", "");
        }
        else
        {
            CharacterControl.updateCharacter(user.uid, id, newData, function(success, error, errorDescription)
            {
                button.setAttribute("class", "");
                
                if(!success && error)
                {
                    SubWindowHelper.alert("Error Saving", error + ". " + errorDescription);
                }
            });
        }
    }, display.getContent());
    
    var deleteButton = HTMLHelper.addButton("Delete", function()
    {
        var button = this;
        button.setAttribute("class", "pendingButton");
        
        SubWindowHelper.confirm("Delete", "Are you sure you want to delete this character?", function(toDelete)
        {
            if(toDelete)
            {
                var data = getSaveData();
                data.visible = false;
                CharacterControl.updateCharacter(user.uid, id, data, function(success, error, errorDescription)
                {
                    if(!success)
                    {
                        SubWindowHelper.alert("Error Deleting", "Error hiding. " + error + ". " + errorDescription);
                    }
                    
                    charactersRefrence.child(id).set(null).then(function()
                    {
                        var intId = MathHelper.forceParseInt(id + "");
                        
                        var shiftLeft = function(n)
                        {
                            charactersRefrence.child((n) + "").once("value", function(data)
                            {
                                var json = data.val();
                                if(json !== null)
                                {
                                    console.log("Setting...");
                                    json.index = n - 1;
                                    charactersRefrence.child((n - 1) + "").set(json).then(function()
                                    {
                                        console.log("OK");
                                        charactersRefrence.child((n) + "").set(null).then(function()
                                        {
                                            console.log("OK2... RECURSION...");
                                            shiftLeft(n + 1);
                                        }).catch(function(error)
                                        {
                                            SubWindowHelper.alert("Error Deleting", "Error shifting index " + n + " left. Clearing next error: " + error);
                                            button.setAttribute("class", "");
                                        });
                                    }).catch(function(error)
                                    {
                                        SubWindowHelper.alert("Error Deleting", "Error shifting index " + n + " left. Shift error: " + error);
                                        button.setAttribute("class", "");
                                    });
                                }
                                else
                                {
                                    button.setAttribute("class", "");
                                    display.close();
                                }
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Deleting", "Error shifting index " + n + " left. Access error: " + error);
                                button.setAttribute("class", "");
                            });
                        };
                        shiftLeft(intId + 1);
                        
                    }).catch(function(error)
                    {
                        button.setAttribute("class", "");
                        
                        SubWindowHelper.alert("Error Deleting", "Error setting to null: " + error);
                    });
                });
            }
            else
            {
                button.setAttribute("class", "");
                
                button.innerHTML = "Not deleted.";
                
                setTimeout(function()
                {
                    button.innerHTML = "Delete";
                }, 700);
            }
        });
    }, display.getContent());
};

CharacterControl["viewCharacters"] = function()
{
    var user = window.authorization.currentUser;
    
    var display = SubWindowHelper.create({"title": "Character List"});
    
    var contentDiv = document.createElement("div");
    
    if(!user)
    {
        HTMLHelper.addLabel("Please sign in before using this feature.", contentDiv, "div");
    }
    else
    {
        var warningLabel = HTMLHelper.addLabel("Warning: This display does not update! Please open and close to refresh.", contentDiv, "div");
        warningLabel.setAttribute("style", "color: rgba(0, 0, 255, 0.9); font: bold 14pt sans; transform: rotate(3deg); text-shadow: 3px 3px rgba(0, 0, 0, 0.3);"); 
        
        var remainingCharactersDisplay = HTMLHelper.addLabel("", contentDiv, "div");
        var characterList = document.createElement("div");
        
        characterList.setAttribute("class", "characterList");
        
        
        var charactersRefrence = users.child(user.uid).child("characters");
        var remainingCharacters = CharacterControl.maxCharacters;
        
        var displayRemainingCharacters = function()
        {
            remainingCharactersDisplay.innerHTML = remainingCharacters;
        };
        
        var allCharacters = undefined;
        var characterCount = 0;
        var addCharacter = function(id, data)
        {
            var characterLine = document.createElement("div");
            
            var characterButton = HTMLHelper.addButton(HTMLHelper.textToHTML(data.name) + ": " + HTMLHelper.textToHTML(data.class) + " " + data.level, function()
            {
                CharacterControl.editCharacter(id, data);
                display.close();
            }, characterLine, []);
            
            var toggleVisibleButton = HTMLHelper.addButton(data.visible ? "Visible" : "Hidden", function()
            {
                data.visible = !data.visible;
                
                var button = this;
                
                CharacterControl.updateCharacter(user.uid, id, data, function(success, error, errorDescription)
                {
                    if(success)
                    {
                        if(data.visible)
                        {
                            button.innerHTML = "Visible";
                        }
                        else
                        {
                            button.innerHTML = "Hidden";
                        }
                    }
                    else
                    {
                        SubWindowHelper.alert("Error Changing Visibility", error + ". " + errorDescription);
                        data.visible = !data.visible;
                    }
                });
            }, characterLine); 
            
            var copyButton = HTMLHelper.addButton("Copy", function()
            {
                var button = this;
                button.setAttribute("class", "pendingButton");
                
                var newData = CharacterControl.createEmptyCharacter(characterCount);
                data.index = newData.content.index;
                
                CharacterControl.updateCharacter(user.uid, newData.characterId, data, function(success, error, errorDescription)
                {
                    if(success)
                    {
                        button.setAttribute("class", "");
                        
                        display.close();
                        CharacterControl.viewCharacters();
                    }
                    else
                    {
                        SubWindowHelper.alert("Error Copying Character", error + ". " + errorDescription);
                        button.setAttribute("class", "");
                    }
                });
            }, characterLine); 
            
            
            
            var zeroButton = HTMLHelper.addButton("Zero", function()
            {
                var button = this;
                button.setAttribute("class", "pendingButton");
                
                data.position.x = 0;
                data.position.y = 0;
                
                CharacterControl.updateCharacter(user.uid, id, data, function(success, error, errorDescription)
                {
                    if(success)
                    {
                        button.setAttribute("class", "");
                    }
                    else
                    {
                        SubWindowHelper.alert("Error Moving Character", error + ". " + errorDescription);
                        button.setAttribute("class", "");
                    }
                });
            }, characterLine); 
            
            characterList.appendChild(characterLine);
            
            remainingCharacters--;
            characterCount++;
            displayRemainingCharacters();
        };
        
        HTMLHelper.addButton("New Character", function()
        {
            display.close();
            
            var data = CharacterControl.createEmptyCharacter(characterCount);
            CharacterControl.editCharacter(data.characterId, data.content);
        }, contentDiv);
        
        charactersRefrence.once("value", function(charactersData)
        {
            allCharacters = charactersData.val();
            charactersData.forEach(function(characterData)
            {
                var characterId = characterData.key;
                var json = characterData.val();
                
                addCharacter(characterId, json);
            });
        });
    }
    
    contentDiv.appendChild(characterList);
    
    display.appendChild(contentDiv);
};

CharacterControl["forEveryCharacter"] = function(onEach)
{
    var user = window.authorization.currentUser;
    
    if(!user)
    {
        throw "You must be signed in!";
    }
    
    for(var uid in AuthorizationHelper.activeUsers)
    {
        var charactersRefrence = users.child(uid).child("characters");

        charactersRefrence.once("value", function(charactersData)
        {
            allCharacters = charactersData.val();
            charactersData.forEach(function(characterData)
            {
                var characterId = characterData.key;
                var json = characterData.val();
                
                console.warn(uid + " -- " + characterId);
                
                try
                {
                    onEach(uid, characterId, json);
                }
                catch(error)
                {
                    console.error(error);
                }
            });
        });
    }
};

CharacterControl["forEveryUserCharacter"] = function(uid, onEach)
{
    var charactersRefrence = users.child(uid).child("characters");

    charactersRefrence.once("value", function(charactersData)
    {
        allCharacters = charactersData.val();
        charactersData.forEach(function(characterData)
        {
            var characterId = characterData.key;
            var json = characterData.val();
            
            
            console.warn(uid + " --- " + characterId);
            
            onEach(uid, characterId, json);
        });
    });
};

CharacterControl["onCharacterChanged"] = function(listener)
{
    var user = window.authorization.currentUser;
    
    if(!user)
    {
        throw "You must be signed in!";
    }
    
    gameData.child("lastCharacterChange").on("value", function(data)
    {
        listener(data.val());
    });
};

function Window(parent, windowList, windowCount, options)
{
    options = options || {};
    
    var classPrefix = "base";
    if(options.classPrefix)
    {
        classPrefix = options.classPrefix;
    }
    
    this.minWidth = options.minWidth !== undefined ? options.minWidth : 100;
    this.minHeight = options.minHeight !== undefined ? options.minHeight : 100;
    
    this.id = windowCount + "";
    windowList[this.id] = this;
    
    this.draggableDisplay = document.createElement("div");
    this.draggableDisplay.setAttribute("class", "draggableHelper");
    this.draggableDisplay.style.display = "none";

    this.element = document.createElement("div");
    this.title = document.createElement("div");
    this.content = document.createElement("div");
    this.closeButton = document.createElement("span");
    this.dragCircle = document.createElement("div");
    this.content = document.createElement("div");
    
    this.title.setAttribute("class", classPrefix + "WindowTitleBar windowTitleBar");
    this.content.setAttribute("class", classPrefix + "WindowContent windowContent");
    this.closeButton.setAttribute("class", classPrefix + "WindowCloseButton windowCloseButton");
    this.element.setAttribute("class", classPrefix + "Window window");
    this.dragCircle.setAttribute("class", classPrefix + "WindowDragCircle windowDragCircle");
    
    this.title.innerHTML = options.title || "Untitled Window";
    this.closeButton.innerHTML = "X";
    this.element.style.zIndex = windowCount;
    
    if(options.width)
    {
        this.element.style.width = options.width;
    }
    
    if(options.height)
    {
        this.element.style.height = options.height;
    }
    
    if(options.x)
    {
        this.element.style.left = options.x;
    }
    
    if(options.y)
    {
        this.element.style.top = options.y;
    }
    
    if(options.maxWidth)
    {
        this.element.style.maxWidth = options.maxWidth;
    }
    
    if(options.onClose)
    {
        this.onClose = options.onClose;
    }
    
    if(options.scrollX === false)
    {
        this.element.style.overflowX = "hidden";
        this.content.style.overflowX = "hidden";
    }
    
    if(options.scrollY === false)
    {
        this.element.style.overflowY = "hidden";
        this.content.style.overflowY = "hidden";
    }
    
    var zIndex = 5;
    this.element.style.zIndex = zIndex;
    
    parent.appendChild(this.element);
    parent.appendChild(this.draggableDisplay);
    this.element.appendChild(this.title);
    
    if(options.XButton === undefined || options.XButton)
    {
        this.element.appendChild(this.closeButton);
    }
    
    if(options.resizable === undefined || options.resizable)
    {
        this.element.appendChild(this.dragCircle);
    }
    
    this.element.appendChild(this.content);
    
    var me = this;
    this.lock = function()
    {
        var lockDiv = document.createElement("div");
        lockDiv.style.position = "absolute";
        lockDiv.style.left = 0;
        lockDiv.style.right = 0;
        lockDiv.style.top = 0;
        lockDiv.style.bottom = 0;
        
        me.element.appendChild(lockDiv);
    };
    
    this.close = function()
    {
        me.lock();
        
        if(me.onClose)
        {
            me.onClose();
        }
        
        HTMLHelper.transitionProperty(function(value) { me.element.style.filter = "opacity(" + value + "%) sepia(" + (100 - value) + "%)"; },
            100, 0, 1000, function()
        {
            setTimeout(function()
            {
                parent.removeChild(me.element);
                delete windowList[me.id];
            }, 100);
        }, false, 0);
    };
    
    this.setTitle = function(title)
    {
        me.title.innerHTML = title;
    };
    
    this.destroy = this.close;
    
    this.hide = function()
    {
        me.element.style.display = "none";
    };
    
    this.show = function()
    {
        me.element.style.display = "block";
    };
    
    this.setZIndex = function(setTo)
    {
        zIndex = setTo;
        me.element.style.zIndex = setTo;
    };
    
    this.getZIndex = function()
    {
        return zIndex;
    };
    
    this.appendChild = function(childElement)
    {
        me.content.appendChild(childElement);
    };
    
    this.getContent = function()
    {
        return me.content;
    };
    
    this.raise = function()
    {
        var minZIndex = 5;
        var windowArray = [];
        
        for(var key in windowList)
        {
            windowArray.push(windowList[key]);
        }
        
        var maxZIndex = HTMLHelper.normalizeZIndiciesAndGetMax(windowArray, minZIndex);
        
        me.setZIndex(maxZIndex + 1);
    };
    
    this.loadDragListeners = function(setProperty, getInitial, startElement)
    {
        var lastX, lastY;
        var dragX, dragY;
        var dragging = false;
        
        var dragStart = function(clientX, clientY)
        {
            var initial = getInitial();
            
            lastX = clientX;
            lastY = clientY;
            
            dragX = initial.x;
            dragY = initial.y;
            
            me.draggableDisplay.style.display = "block";
            me.raise();
            
            dragging = true;
        };
        
        var dragMove = function(clientX, clientY)
        {
            if(dragging)
            {
                var deltaX = clientX - lastX;
                var deltaY = clientY - lastY;
                
                dragX += deltaX;
                dragY += deltaY;
                
                setProperty(dragX, dragY);
                
                lastX = clientX;
                lastY = clientY;
            }
        };
        
        var dragEnd = function()
        {
            dragging = false;
            me.draggableDisplay.style.display = "none";
        };
        
        startElement.onmousedown = HTMLHelper.eventArgumentToXY(dragStart, true);
        
        // Chain a call to HTMLHelper.eventArgumentToXY(...) with whatever the listener was previously.
        HTMLHelper.chainOldAndNew(me.draggableDisplay.onmousemove, HTMLHelper.eventArgumentToXY(dragMove, true), function(newFunction) { me.draggableDisplay.onmousemove = newFunction; });
        HTMLHelper.chainOldAndNew(me.draggableDisplay.onmouseup, HTMLHelper.eventArgumentToXY(dragEnd, true), function(newFunction) { me.draggableDisplay.onmouseup = newFunction; });
        HTMLHelper.chainOldAndNew(me.draggableDisplay.onmouseleave, HTMLHelper.eventArgumentToXY(dragEnd, true), function(newFunction) { me.draggableDisplay.onmouseleave = newFunction; });
        
        startElement.addEventListener("touchstart", function(e)
        {
            e.preventDefault();
            var touchEvent1 = e.changedTouches[0];
            dragStart(touchEvent1.clientX, touchEvent1.clientY);
        }, true);
        
        startElement.addEventListener("touchmove", function(e)
        {
            e.preventDefault();
            var touchEvent1 = e.changedTouches[0];
            dragMove(touchEvent1.clientX, touchEvent1.clientY);
        }, true);
        
        startElement.addEventListener("touchend", function(e)
        {
            e.preventDefault();
            var touchEvent1 = e.changedTouches[0];
            dragEnd(touchEvent1.clientX, touchEvent1.clientY);
        }, true);
        
        
        me.draggableDisplay.addEventListener("touchmove", function(e)
        {
            e.preventDefault();
            var touchEvent1 = e.changedTouches[0];
            dragMove(touchEvent1.clientX, touchEvent1.clientY);
        }, true);
        
        me.draggableDisplay.addEventListener("touchend", function(e)
        {
            e.preventDefault();
            var touchEvent1 = e.changedTouches[0];
            dragEnd(touchEvent1.clientX, touchEvent1.clientY);
        }, true);
    };
    
    this.loadCloseListeners = function()
    {
        me.closeButton.onclick = function()
        {
            me.close();
        };
    };
    
    // Move
    this.loadDragListeners(function(x, y)
    {
        me.element.style.left = x + "px";
        me.element.style.top = y + "px";
    }, function()
    {
        var bbox = me.element.getBoundingClientRect();
        
        var location = {"x": bbox.left, "y": bbox.top};
        
        return location;
    }, me.title);
    
    // Resize
    this.loadDragListeners(function(width, height)
    {
        if(width < me.minWidth)
        {
            width = me.minWidth;
        }
        
        if(height < me.minHeight)
        {
            height = me.minHeight;
        }
        
        me.element.style.width = width + "px";
        me.element.style.height = height + "px";
        
        if(me.onresize)
        {
            me.onresize();
        }
    }, function()
    {
        var location = {"x": me.element.clientWidth, "y": me.element.clientHeight};
        
        return location;
    }, me.dragCircle);
    
    me.dragCircle.ondblclick = function(event)
    {
        if(me.element.style.width !== "100%")
        {
            me.element.style.width = "100%";
        }
        else if(me.element.style.height !== "100%")
        {
            me.element.style.height = "100%";
        }
        else
        {
            me.element.style.width = options.width || "";
            me.element.style.height = options.height || "";
        }
        
        if(me.onresize)
        {
            me.onresize();
        }
    };
    
    this.loadCloseListeners();
    
    this.element.addEventListener("click", function()
    {
        me.raise();
    });
    
    this.raise();
    
    if(!options.x && !options.y)
    {
        requestAnimationFrame(function()
        {
            me.element.style.left = Math.floor(window.innerWidth / 2 - me.element.clientWidth/2) + "px";
            me.element.style.top = Math.floor(window.innerHeight / 2 - me.element.clientHeight/2) + "px";
        });
    }
    
    requestAnimationFrame(function()
    {
        me.content.style.height = (me.element.clientHeight - me.title.clientHeight) + "px";
        
        me.onresize = function()
        {
            me.content.style.height = (me.element.clientHeight - me.title.clientHeight) + "px";
        };
        
        HTMLHelper.chainOldAndNew(document.body.onresize, function()
        {
            me.onresize();
        }, function(newResize)
        {
            document.body.onresize = newResize;
        });
        
        me.raise();
    });
}

function MainRibbon(parent)
{
    this.window = SubWindowHelper.create({ XButton: false, width: "100%", height: "auto", x: "0px", y: "0px", title: "Controls", classPrefix: "controls"});
    this.parent = parent;
    
    var me = this;
    
    this.hide = this.window.hide;
    this.show = this.window.show;
    this.loadAccountOptions = function()
    {
        var result = HTMLHelper.commandMapToButtons(
        {
            "Sign Out": function() 
            {
                AuthorizationHelper.noteSignOut(function()
                {
                    window.authorization.signOut().then(function()
                    {
                        SubWindowHelper.alert("Sign Out", "You have been signed out.");
                    }).catch(function(error)
                    {
                        SubWindowHelper.alert("Error Signing Out", "Error: " + error.message);
                    });
                });
            },
            "Update Profile/Profile Information": function(e)
            {
                var user = window.authorization.currentUser;
                var profileInformationWindow = SubWindowHelper.create({title: "Profile Information", "height": "auto"});
                var profileInformationZone = document.createElement("div");
                HTMLHelper.addLabel("Display Name: ", profileInformationZone, "span");
                var nameInput = HTMLHelper.addInput("Display Name", user.displayName, profileInformationZone, "text");
                HTMLHelper.addLabel("User ID: " + user.uid, profileInformationZone, "div");
                HTMLHelper.addLabel("Email Address: " + user.email, profileInformationZone, "div");
                HTMLHelper.addLabel("Sign In Provider: " + user.providerId, profileInformationZone, "div");
                
                var submitButton = HTMLHelper.addButton("Submit Changes", function(event)
                {
                    var newDisplayName = nameInput.value;
                    var changesMade = false;
                    
                    if(newDisplayName !== user.displayName)
                    {
                        user.updateProfile(
                        {
                            "displayName": newDisplayName,
                            "photoURL": ""
                        }).then(function()
                        {
                            SubWindowHelper.alert("Profile Options", "Display name changed.");
                            
                            AuthorizationHelper.updateUserData(function()
                            {
                                SubWindowHelper.alert("Profile Options", "New display name publicized.");
                                
                                AuthorizationHelper.noteInfoChange();
                            });
                        }).catch(function(error)
                        {
                            SubWindowHelper.alert("Error Updating Profile", error.message);
                        });
                        
                        changesMade = true;
                    }
                    
                    if(!changesMade)
                    {
                        SubWindowHelper.alert("Profile Options", "No changes to make.");
                    }
                    
                    profileInformationWindow.close();
                }, profileInformationZone);
                
                profileInformationWindow.appendChild(profileInformationZone);
            },
            "Change Password": function(e)
            {
                AuthenticationHelper.reAuthenticate(function()
                {
                    var user = window.authorization.currentUser;
                    
                    SubWindowHelper.multiInputPrompt("Change Password", "Enter the new password. ", ["Password", "Confirm Password"], ["password", "password"], function(results)
                    {
                        var password = results[0],
                            confirmPassword = results[1];
                        if(password === confirmPassword)
                        {
                            user.updatePassword(password).then(function()
                            {
                                SubWindowHelper.alert("Change Password", "Password changed!");
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Changing Password", "Error: " + error.message + ".");
                            });
                        }
                        else
                        {
                            SubWindowHelper.alert("Change Password", "Passwords did not match.");
                        }
                    }, undefined, "Yes", "No");
                });
            },
            "Change Email Address": function(event)
            {
                AuthenticationHelper.reAuthenticate(function()
                {
                    var user = window.authorization.currentUser;
                    
                    SubWindowHelper.multiInputPrompt("Change Email Address", "Enter and confirm the new email address. ", ["Email", "Confirm Email"], ["email", "email"], function(results)
                    {
                        var email = results[0],
                            confirmEmail = results[1];
                        if(email === confirmEmail)
                        {
                            user.updateEmail(email).then(function()
                            {
                                SubWindowHelper.alert("Change Email Address", "Email address changed!");
                                
                                AuthorizationHelper.updateUserData(function()
                                {
                                    SubWindowHelper.alert("Change Email Address", "Changes publicized.");
                                    
                                    AuthorizationHelper.noteInfoChange();
                                });
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Updating Email Address", "Error: " + error.message + ".");
                            });
                        }
                        else
                        {
                            SubWindowHelper.alert("Change Email Address", "The email address did not match.");
                        }
                    }, undefined, "Yes", "No");
                });
            },
            "Delete Account": function(e) 
            {
                AuthenticationHelper.reAuthenticate(function()
                {
                    var user = window.authorization.currentUser;
                    
                    SubWindowHelper.confirm("Delete Account", "Are you sure you want to delete this account?", function(result)
                    {
                        if(result)
                        {
                            AuthorizationHelper.noteSignOut(function()
                            {
                                users.child(user.uid).set(null).then(function()
                                {
                                    SubWindowHelper.alert("Delete Account", "Data deleted.");
                                    
                                    user.delete().then(function()
                                    {
                                        SubWindowHelper.alert("Delete Account", "Account deleted.");
                                        
                                        
                                    }).catch(function(error)
                                    {
                                        SubWindowHelper.alert("Error Deleting User", "Error: " + error.message + ".");
                                    });
                                }).catch(function(error)
                                {
                                    SubWindowHelper.alert("Error", "Error deleting data: " + error.message + ".");
                                });
                            });
                        }
                        else
                        {
                            SubWindowHelper.alert("Delete Account", "Account NOT deleted.");
                        }
                    }, undefined, "Yes", "No");
                });
            }
        });
        
        setTimeout(function()
        {
            if(window.authorization && !window.authorization.currentUser.emailVerified)
            {
                var emailStatusLabel = HTMLHelper.addLabel("Your email address has not been verified.", result, "span");
                
                var verifyButton;
                verifyButton = HTMLHelper.addButton("Verify Email", function(event)
                {
                    AuthenticationHelper.verifyEmail();
                    emailStatusLabel.innerHTML = "Waiting for verification...";
                    
                    var checkButton;
                    checkButton = HTMLHelper.addButton("Check for verification.", function()
                    {
                        if(!window.authorization.currentUser.emailVerified)
                        {
                            emailStatusLabel.innerHTML = "Waiting for verification... Not verified. If you <b>have</b> verified your email, please refresh this page.";
                        }
                        else
                        {
                            emailStatusLabel.innerHTML = "Email verified!";
                            checkButton.style.display = "none";
                            verifyButton.style.display = "none";
                        }
                    }, result);
                }, result);
            }
        }, 1000);
        
        return result;
    };
    
    this.loadPlayerOptions = function()
    {
        var playerOptionsButtonMap = 
        {
            "Character Manager": function(e) 
            {
                CharacterControl.viewCharacters();
            },
            "Chat": function(e) 
            {
                CommunicationHelper.launchChatWindow();
            },
            "Chat to GM": function(e)
            {
                CommunicationHelper.launchChatWindow(true);
            },
            "Change Background Drag": function()
            {
                me.parent.background.normalDrag = !me.parent.background.normalDrag;
                
                this.innerHTML = "Change Background Drag -- " + (me.parent.background.normalDrag ? "Normal Drag" : "Momentum Drag");
            }
        };
        
        if(window.RoomSimulation)
        {
            playerOptionsButtonMap["Open Room Simulation"] = function(e)
            {
                if(this.innerHTML === "Open Room Simulation")
                {
                    this.innerHTML = "Close Room Simulation";
                    me.parent.simulation.show();
                }
                else
                {
                    this.innerHTML = "Open Room Simulation";
                    me.parent.simulation.hide();
                }
            };
        }
        
        playerOptionsButtonMap["View Game Description"] = function(e)
        {
            var descriptionWindow = SubWindowHelper.create({ title: "Game Description", scrollX: false, scrollY: false });
            
            var pageView = document.createElement("iframe");
            pageView.style.width = "100%";
            pageView.style.height = "100%";
            pageView.style.border = "0px solid black";
            
            pageView.src = "description.html";
            
            descriptionWindow.appendChild(pageView);
        };
        
        playerOptionsButtonMap["Development Tools"] = function(e)
        {
            var tools = SubWindowHelper.create({ title: "Development Tools", "height": "auto" });
            
            var content = document.createElement("div");
            
            var display = HTMLHelper.addLabel(navigator.userAgent + " -- Safari: " + (navigator.userAgent.indexOf("iPad") > -1), content, "div"); 
            var commandInput = HTMLHelper.addInput("Enter Command ", "", content, "text");
            var submitButton = HTMLHelper.addButton("Submit", function()
            {
                try
                {
                    display.textContent = eval(commandInput.value);
                    display.style.color = "green";
                }
                catch(e)
                {
                    display.textContent = e;
                    display.style.color = "red";
                }
            }, content, [commandInput]);
            
            tools.appendChild(content);
        };
        
        var result = HTMLHelper.commandMapToButtons(playerOptionsButtonMap);
        
        return result;
    };
    
    this.loadGMOptions = function()
    {
        var result = HTMLHelper.commandMapToButtons(
        {
            "Background Options": function()
            {
                var backgroundOptionsWindow = SubWindowHelper.create({title: "Background Options", "height": "auto"});
                
                var windowContent = document.createElement("div");
                
                var buttons = HTMLHelper.commandMapToButtons(
                {
                    "Set Background URL": function()
                    {
                        SubWindowHelper.prompt("URL", "", "Background URL", function(newURL)
                        {
                            gameData.child("background").child("src").set(newURL).then(function()
                            {
                                SubWindowHelper.alert("Success!", newURL);
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Setting SRC", error);
                            });
                        }, "text");
                    },
                    "Set Background Rotation": function()
                    {
                        SubWindowHelper.prompt("Rotation", "", "Background Rotation (Degrees)", function(newRotation)
                        {
                            newRotation *= Math.PI / 180.0;
                            
                            gameData.child("background").child("rotate").set(newRotation).then(function()
                            {
                                SubWindowHelper.alert("Success!", newRotation);
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Rotating Background Rotation", error);
                            });
                        }, "text");
                    },
                    "Set Background Scale": function()
                    {
                        SubWindowHelper.prompt("Scale", "", "Background Scale (0 to 1)", function(newScale)
                        {
                            newScale = MathHelper.forceParseFloat(newScale);
                            gameData.child("background").child("scale").set(newScale).then(function()
                            {
                                SubWindowHelper.alert("Success!", newScale);
                            }).catch(function(error)
                            {
                                SubWindowHelper.alert("Error Setting Background Scale", error);
                            });
                        }, "text");
                    }
                });
                
                windowContent.appendChild(buttons);
                
                HTMLHelper.addButton("Draw Background", function()
                {
                    var drawBackgroundWindow = SubWindowHelper.create({title: "Draw Background"});
                    
                    var content = drawBackgroundWindow.getContent();
                    
                    CommunicationHelper.listenOnce(CommunicationHelper.resourceNames.BACKGROUND_SRC, function(src)
                    {
                        var checkLengthContainer = {};
        
                        var imageSrc = HTMLHelper.addBoundedInput("Background Src", src, 100000, content, "text", checkLengthContainer);
                        var submitButton, submit;
                        var autoUpdate = false;
                        
                        var editorWidth = 500,
                            editorHeight = 500;
                        
                        submit = function()
                        {
                            if(submitButton)
                            {
                                submitButton.setAttribute("class", "pendingButton");
                                
                                gameData.child("background").child("src").set(imageSrc.value).then(function()
                                {
                                    submitButton.setAttribute("class", "");
                                }).catch(function(error)
                                {
                                    submitButton.setAttribute("class", "");
                                    SubWindowHelper.alert("Error Setting SRC", error);
                                });
                            }
                            else
                            {
                                console.warn("Button is null!");
                            }
                        };
                        
                        var autoUpdateButton = HTMLHelper.addButton("Auto Update", function()
                        {
                            autoUpdate = !autoUpdate;
                            
                            if(autoUpdate)
                            {
                                this.innerHTML = "No Auto Update";
                            }
                            else
                            {
                                this.innerHTML = "Auto Update";
                            }
                        }, content);
                        
                        var toGrid = HTMLHelper.addButton("To Grid", function()
                        {
                            SubWindowHelper.prompt("Number of Sections", "How many horizontal lines?", "", function(lines)
                            {
                                var numSections = MathHelper.forceParseFloat(lines);
                                imageSrc.value = "dw-m0,0m0," + editorHeight + "m" + editorWidth + "," + editorHeight + "m" + editorWidth + ",0sF256,256,256,1fb";
                                
                                var gridSection = "";
                                
                                var y;
                                for(var x = 0; x < editorWidth; x += editorWidth / numSections)
                                {
                                    gridSection += "m" + x + ",0";
                                    gridSection += "m" + x + "," + editorHeight;
                                    gridSection += "sb";
                                }
                                
                                for(y = 0; y < editorHeight; y += editorWidth / numSections)
                                {
                                    gridSection += "m0," + y;
                                    gridSection += "m" + editorWidth + "," + y;
                                    gridSection += "sb";
                                }
                                
                                imageSrc.value += gridSection;
                                
                                imageEditor.setSrc(imageSrc.value);
                                
                                if(autoUpdate)
                                {
                                    submit();
                                }
                            }, "number");
                        }, content);
                        
                        var imageEditor = new DrawingEditor(content, imageSrc.value, editorWidth, editorHeight);
                        
                        imageEditor.setSrcChangeListener(function()
                        {
                            imageSrc.value = imageEditor.src;
                            
                            checkLengthContainer.checkLength();
                            
                            if(autoUpdate)
                            {
                                submit();
                            }
                        });
                        
                        imageSrc.oninput = function()
                        {
                            imageEditor.setSrc(imageSrc.value);
                        };
                        
                        submitButton = HTMLHelper.addButton("Save", function()
                        {
                            submitButton = this;
                            
                            submit();
                        }, content);
                    });
                }, windowContent);
                
                backgroundOptionsWindow.appendChild(windowContent);
            },
            "Set Visible Radius": function()
            {
                SubWindowHelper.prompt("Visible Radius", "", "New Visible Radius Scale (0 to turn off): ", function(newRadius)
                {
                    newRadius = MathHelper.forceParseFloat(newRadius);
                    gameData.child("visionRadius").set(newRadius).then(function()
                    {
                        SubWindowHelper.alert("Success!", newRadius);
                    }).catch(function(error)
                    {
                        SubWindowHelper.alert("Error Setting Visible Radius", error);
                    });
                }, "text");
            },
            "Hide Online Characters": function()
            {
                this.setAttribute("class", "pendingButton");
                
                me.parent.hideAllCharacters();
                
                this.setAttribute("class", "");
            },
            "Status Text Options": function()
            {
                var statusTextWindow = SubWindowHelper.create({title: "Status Text Options", "height": "auto"});
                
                var content = document.createElement("div");
                statusTextWindow.appendChild(content);
                
                gameData.child("statusText").once("value", function(data)
                {
                    var json = data.val();
                    
                    json = json || {};
                
                    HTMLHelper.addLabel("Content: ", content, "span");
                    var contentInput = HTMLHelper.addBoundedInput("Status Text", json.text, 800, content, "text");
                    HTMLHelper.addLineBreak(content);
                    
                    var color = JSHelper.colorStringToArray(json.color || "");
                    var backgroundColor = JSHelper.colorStringToArray(json.backgroundColor || "");
                    
                    HTMLHelper.addButton("Change Text Color", function()
                    {
                        SubWindowHelper.promptForColor("Set Status Text Color", "", color, function(red, green, blue, alpha)
                        {
                            color[0] = red;
                            color[1] = green;
                            color[2] = blue;
                            color[3] = alpha;
                        });
                    }, content);
                    
                    HTMLHelper.addButton("Change Background Color", function()
                    {
                        SubWindowHelper.promptForColor("Set Status Text Background Color", "", backgroundColor, function(red, green, blue, alpha)
                        {
                            backgroundColor[0] = red;
                            backgroundColor[1] = green;
                            backgroundColor[2] = blue;
                            backgroundColor[3] = alpha;
                        });
                    }, content);
                    
                    HTMLHelper.addLineBreak(content);
                    
                    HTMLHelper.addLabel("Duration: ", content, "span");
                    var durationInput = HTMLHelper.addInput("Duration", json.duration || 5000, content, "text");
                    HTMLHelper.addLineBreak(content);
                    
                    HTMLHelper.addButton("Submit", function()
                    {
                        this.setAttribute("class", "pendingButton");
                        var button = this;
                        
                        gameData.child("statusText").set(
                        {
                            timeStamp: (new Date()).getTime(),
                            color: "rgba(" + color.join(",") + ")",
                            backgroundColor: "rgba(" + backgroundColor.join(",") + ")",
                            text: contentInput.value,
                            duration: MathHelper.forceParseInt(durationInput.value)
                        }).then(function()
                        {
                            button.setAttribute("class", "");
                        }).catch(function(error)
                        {
                            button.setAttribute("class", "");
                            
                            SubWindowHelper.alert("Error Saving", error);
                        });
                    }, content, [contentInput, durationInput]);
                }).catch(function(error)
                {
                    content.innerHTML = "Error fetching data: " + error;
                });
            },
            "3D World Options": function()
            {
                var optionsWindow = SubWindowHelper.create({"title": "3D World Options", "height": "auto"});
                
                var content = document.createElement("div");
                
                var mapRef = gameData.child("world3DMap");
                
                HTMLHelper.addButton("Change Background Color", function()
                {
                    var currentColor = me.parent.simulation.backgroundColor;
                    
                    SubWindowHelper.promptForColor("New Background Color", "", [currentColor.r, currentColor.g, currentColor.b, 1.0], function(red, green, blue)
                    {
                        colorString = "rgba(" + [red, green, blue].join(",") + ", 1.0)";
                        mapRef.child("backgroundColor").set(colorString).then(
                        function()
                        {
                            SubWindowHelper.alert("Background Changed", colorString);
                        }).catch(
                        function(error)
                        {
                            SubWindowHelper.alert("Error Setting Background Color", error.message || error);
                        });
                    });
                }, content);
                
                HTMLHelper.addButton("Change Background Cube Count", function()
                {
                    var button = this;
                    button.setAttribute("class", "pendingButton");
                    
                    var currentCubeCount = me.parent.simulation.getProperty("cubeCount");
                    
                    SubWindowHelper.prompt("Cube Count", "", "" + currentCubeCount, function(newCubeCount)
                    {
                        var newValue = MathHelper.forceParseInt(newCubeCount);
                        
                        mapRef.child("backgroundCubeCount").set(newValue).then(
                        function()
                        {
                            button.setAttribute("class", "");
                        }).catch(
                        function(error)
                        {
                           SubWindowHelper.alert("Error Setting Cube Count", error.message || error);
                           button.setAttribute("class", "");
                        });
                    }, "number");
                }, content);
                
                HTMLHelper.addButton("Change Background Time Divider", function()
                {
                    var button = this;
                    button.setAttribute("class", "pendingButton");
                    
                    var currentTimeDivider = me.parent.simulation.getProperty("timeDivider");
                    
                    SubWindowHelper.prompt("Time Divider", "", "" + currentTimeDivider, function(newTimeDivider)
                    {
                        var newValue = MathHelper.forceParseFloat(newTimeDivider);
                        
                        mapRef.child("backgroundCubeTimeDivider").set(newValue).then(function()
                        {
                            button.setAttribute("class", "");
                        }).catch(function(error)
                        {
                            SubWindowHelper.alert("Error Changing Time Divider", error.message || error);
                            button.setAttribute("class", "");
                        });
                    }, "number");
                }, content);
                
                HTMLHelper.addButton("Change Shared Cube Texture Src", function()
                {
                    var button = this;
                    button.setAttribute("class", "pendingButton");
                    
                    var currentSrc = me.parent.simulation.getProperty("sharedCubeSrc");
                    
                    SubWindowHelper.prompt("Shared Cube Src", "", "" + currentSrc, function(newSrc)
                    {
                        var newValue = newSrc;
                        
                        mapRef.child("sharedCubeImage").set(newValue).then(function()
                        {
                            CommunicationHelper.setData(CommunicationHelper.resourceNames.WORLD_SHARED_IMAGE_UPDATE, "r", function()
                            {
                                button.setAttribute("class", "");
                            });
                        }).catch(function(error)
                        {
                            SubWindowHelper.alert("Error Changing Cube Src", error.message || error);
                            button.setAttribute("class", "");
                        });
                    }, "textarea");
                }, content);
                
                optionsWindow.appendChild(content);
            },
            "Set Game Description": function()
            {
                var gameDescriptionWindow = SubWindowHelper.create({ title: "Game Description Editor", height: "auto" });
                
                var gameDescriptionTextbox = document.createElement("textarea");
                var submitButton = document.createElement("button");
                
                gameDescriptionTextbox.style.width = "calc(100% - 15px)";
                gameDescriptionTextbox.style.height = "calc(100% - 36px)";
                gameDescriptionTextbox.style.font = "7pt Serif";
                submitButton.innerHTML = "Submit";
                
                gameDescriptionTextbox.value = "Loading...";
                
                gameDescriptionWindow.appendChild(gameDescriptionTextbox);
                gameDescriptionWindow.appendChild(submitButton);
                
                var gameDescriptionLocation = database.ref("gameDescription");
                
                gameDescriptionLocation.once("value", function(data)
                {
                    if(data !== null)
                    {
                        var content = data.val();
                        
                        gameDescriptionTextbox.value = content || "";
                    }
                }).catch(function(error)
                {
                    SubWindowHelper.alert("Game Description Access Error", error.message || error);
                });
                
                submitButton.onclick = function()
                {
                    submitButton.setAttribute("class", "pendingButton");
                    gameDescriptionLocation.set(gameDescriptionTextbox.value).then(
                    function()
                    {
                        submitButton.setAttribute("class", "");
                    }).catch(function(error)
                    {
                        submitButton.setAttribute("class", "");
                        
                        SubWindowHelper.alert("Error Setting Description", error.message || error);
                    });
                };
            }
        });
        
        return result;
    };
    
    
    
    this.loadPresence = function()
    {
        var statusDiv = document.createElement("div");
        statusDiv.style.height = "2.4em";
        
        AuthorizationHelper.addActiveUserChangeListener(function(key, activeUsers)
        {
            statusDiv.innerHTML = "";
            
            var noteUser = function(key)
            {
                var status = document.createElement("span");
                status.setAttribute("class", "userStatus");
                
                status.innerHTML = HTMLHelper.textToHTML(activeUsers[key]);
                
                var showingUID = false;
                status.onclick = function()
                {
                    if(showingUID)
                    {
                        status.innerHTML = HTMLHelper.textToHTML(activeUsers[key]);
                    }
                    else
                    {
                        status.innerHTML = HTMLHelper.textToHTML(key);
                    }
                    
                    showingUID = !showingUID;
                };
                
                statusDiv.appendChild(status);
            }
            
            for(var i in activeUsers)
            {
                noteUser(i);
            }
        });
        
        return statusDiv;
    };
    
    var tabNameMap = {};
    tabNameMap["Account"] = me.loadAccountOptions();
    
    if(!AuthorizationHelper.justDidSignUp)
    {
        tabNameMap["Player Options"] = me.loadPlayerOptions();
        tabNameMap["Presence"] = me.loadPresence();
    }
    
    this.tabControl = new TabbedDisplay(tabNameMap, me.window.getContent());
    
    AuthorizationHelper.checkForAccess(function(access)
    {
        if(access)
        {
            tabNameMap["GM Controls"] = me.loadGMOptions();
            me.tabControl.reload();
        }
    });
}

function TabbedDisplay(tabNameMap, parent)
{
    this.element = document.createElement("div");
    this.options = document.createElement("div");
    this.contentContainer = document.createElement("div");
    this.content = document.createElement("div");
    this.contentElement = document.createElement("div");
    
    this.options.style.columnCount = tabNameMap.length;
    
    /*this.element.style.display = "table";
    this.options.style.display = "table-header-group";
    this.contentContainer.style.display = "table-row-group";
    this.content.style.display = "table-row";
    this.contentElement.style.display = "table-cell";*/
    
    this.options.setAttribute("class", "tabHeader");
    
    this.element.appendChild(this.options);
    this.element.appendChild(this.contentContainer);
    this.contentContainer.appendChild(this.content);
    this.content.appendChild(this.contentElement);
    
    this.element.style.width = "100%";
    this.options.style.width = "100%";
    this.content.style.width = "100%";
    this.contentElement.style.width = "100%";
    
    var me = this;
    
    this.reload = function()
    {
        me.options.innerHTML = "";
        me.contentElement.innerHTML = "";
        
        var tabCount = 0;
        
        for(var i in tabNameMap)
        {
            tabCount++;
        }
        
        var labels = [];
        var addTab = function(key)
        {
            var tabLabel = document.createElement("span"),
                tabContent = document.createElement("div");
            labels.push(tabLabel);
            var myIndex = labels.length - 1;
                
            tabLabel.style.display = "inline-block";
            tabLabel.style.width = Math.floor(1 / tabCount * 100) + "%";
            
            tabLabel.setAttribute("class", "tabLabel");
            
            tabLabel.innerHTML = key;
            tabContent.appendChild(tabNameMap[key]);
            
            tabLabel.onclick = function()
            {
                me.contentElement.innerHTML = "";
            
                me.contentElement.appendChild(tabContent);
                
                for(var index = 0; index < labels.length; index++)
                {
                    if(index !== myIndex)
                    {
                        labels[index].style.filter = "opacity(40%)";
                    }
                    else
                    {
                        labels[index].style.filter = "opacity(80%)";
                    }
                }
            };
            
            me.options.appendChild(tabLabel);
            tabLabel.onclick();
        };
        
        for(var key in tabNameMap)
        {
            addTab(key);
        }
    };
    
    me.reload();
    parent.appendChild(this.element);
}

function SignInManager(onAuthorize, excludeSignUp, parentElement)
{
    this.parentElement = parentElement || document.body;
    this.element = document.createElement("div");
    this.element.setAttribute("class", "signInMenu");
    this.onAuthorize = onAuthorize || function() {};
    
    this.signInElement = document.createElement("div");
    this.signInHeader = document.createElement("h2");
    this.signInUsernameInput = document.createElement("input");
    this.signInPasswordInput = document.createElement("input");
    this.signInSubmit = document.createElement("button");
    this.errorElement = document.createElement("div");
    
    this.signInHeader.innerHTML = "Sign In";
    this.signInUsernameInput.setAttribute("placeholder", "Email");
    this.signInPasswordInput.setAttribute("placeholder", "Password");
    this.signInUsernameInput.type = "text";
    this.signInPasswordInput.type = "password";
    this.signInSubmit.innerHTML = "Submit";
    this.errorElement.style.color = "red";
    
    this.signInElement.appendChild(this.signInHeader);
    HTMLHelper.addLineBreak(this.signInElement);
    this.signInElement.appendChild(this.signInUsernameInput);
    HTMLHelper.addLineBreak(this.signInElement);
    this.signInElement.appendChild(this.signInPasswordInput);
    this.signInElement.appendChild(this.signInSubmit);
    this.signInElement.appendChild(this.errorElement);
    
    
    this.signUpElement = document.createElement("div");
    this.signUpHeader = document.createElement("h2");
    this.termsElement = document.createElement("div");
    this.signUpUsernameInput = document.createElement("input");
    this.signUpPasswordInput = document.createElement("input");
    this.signUpPasswordConfirmInput = document.createElement("input");
    this.signUpSubmit = document.createElement("button");
    this.signUpError = document.createElement("div");
    
    this.signUpHeader.innerHTML = "Sign Up";
    this.signUpUsernameInput.setAttribute("placeholder", "Email");
    this.signUpPasswordInput.setAttribute("placeholder", "Password");
    this.signUpPasswordConfirmInput.setAttribute("placeholder", "Re-Enter Password");
    this.signUpPasswordInput.type = "password";
    this.signUpPasswordConfirmInput.type = "password";
    this.signUpSubmit.innerHTML = "Sign Up!";
    this.signUpError.style.color = "red";
    this.termsElement.innerHTML = "By creating an account you agree that this account can be deleted at any time and/or its data destroyed, for a reason that you may or may not be made aware of. You agree that your data can be used for any purpose with or without your consent. By creating an account you agree that this website is designed for use only by a small group of people. Failure to belong to this group may cause the deletion of your account and/or data. This agreement can be modified without your knowledge or consent. You agree that all modifications to this agreement apply to you and your account. If you do not agree to this, do not create an account.";
    this.termsElement.setAttribute("class", "termsOfUse");
    
    this.signUpElement.appendChild(this.signUpHeader);
    HTMLHelper.addLineBreak(this.signUpElement);
    this.signUpElement.appendChild(this.signUpUsernameInput);
    HTMLHelper.addLineBreak(this.signUpElement);
    this.signUpElement.appendChild(this.signUpPasswordInput);
    HTMLHelper.addLineBreak(this.signUpElement);
    this.signUpElement.appendChild(this.signUpPasswordConfirmInput);
    this.signUpElement.appendChild(this.signUpSubmit);
    this.signUpElement.appendChild(this.signUpError);
    this.signUpElement.appendChild(this.termsElement);
    
    var me = this;
    var signIn = function()
    {
        var userName = me.signInUsernameInput.value;
        var password = me.signInPasswordInput.value;
        
        try
        {
            window.authorization.signInWithEmailAndPassword(userName, password).then(
            function()
            {
                me.errorElement.innerHTML = "";
                me.hide();
                
                try
                {
                    CommunicationHelper.startClosedListeners();
                }
                catch(error)
                {
                    SubWindowHelper.alert("Error Starting Listeners", error);
                }
                
                me.onAuthorize();
            }).catch(
            function(error)
            {
                me.errorElement.innerHTML = "Error code " + error.code + ": " + error.message;
                
                var passwordResetOption = document.createElement("button");
                passwordResetOption.innerHTML = "Send a password reset email.";
                
                me.errorElement.appendChild(passwordResetOption);
                
                passwordResetOption.onclick = function()
                {
                    authorization.sendPasswordResetEmail(userName).then(function()
                    {
                        me.errorElement.innerHTML = "<span style='color: green;'>Email sent.</span>";
                    }).catch(function(error)
                    {
                        me.errorElement.innerHTML = "Error sending email. Code " + error.code + ": " + error.message;
                    });
                };
            });
        }
        catch(error)
        {
            me.errorElement.innerHTML = "Error: " + error;
        }
    };
    
    var signUp = function()
    {
        var email = me.signUpUsernameInput.value;
        var password = me.signUpPasswordInput.value,
            confirmedPassword = me.signUpPasswordConfirmInput.value;
        
        if(password !== confirmedPassword)
        {
            me.signUpError.innerHTML = "Error: Passwords must match!";
            return;
        }
        
        try
        {
            window.authorization.createUserWithEmailAndPassword(email, password).then(
            function()
            {
                me.signUpError.innerHTML = "";
                me.hide();
                
                try
                {
                    CommunicationHelper.startClosedListeners();
                }
                catch(error)
                {
                    console.error(error);
                }
                
                console.log(1);
                AuthorizationHelper.justDidSignUp = true;
                console.log(4);
                SubWindowHelper.alert("Sign Up", "After verifying your email, please refresh the page. Until your email address is verified, \"Access Denied\" errors will appear.");
                AuthenticationHelper.verifyEmail();
                console.log(5);
                
                me.onAuthorize();
            }).catch(
            function(error)
            {
                me.signUpError.innerHTML = "Error code " + error.code + ": " + error.message;
            });
        }
        catch(error)
        {
            me.signUpError.innerHTML = error;
        }
    };
    
    this.signInSubmit.addEventListener("click", signIn);
    this.signUpSubmit.addEventListener("click", signUp);
    
    this.signUpPasswordConfirmInput.addEventListener("keyup", function(e)
    {
        if(e.keyCode === 13)
        {
            signUp(e);
        }
    });
    
    this.signInPasswordInput.addEventListener("keyup", function(e)
    {
        if(e.keyCode === 13)
        {
            signIn(e);
        }
    });
    
    this.load = function()
    {
        var tabMap = {"Sign In": me.signInElement};
        
        if(!excludeSignUp)
        {
            tabMap["Sign Up"] = me.signUpElement;
        }
        
        me.display = new TabbedDisplay(tabMap, me.element);
        me.parentElement.appendChild(me.element);
    };
    
    this.destroy = function()
    {
        me.parentElement.removeChild(me.element);
    };
    
    me.load();
    
    this.show = function()
    {
        me.element.style.display = "block";
    };
    
    this.hide = function()
    {
        me.element.style.display = "none";
    };
}

function DraggableItem(x, y, width, height)
{
    this.x = x || 0;
    this.y = y || 0;
    this.width = width || 10;
    this.height = height || 10;
    this.xVelocity = 0;
    this.yVelocity = 0;
    this.frictionK = 0.93;
    this.canExitScreen = true;
    this.borderWidth = 30;
    this.originalFriction = this.frictionK;
    this.zIndex = 1;
    this.parent = null;
    this.children = {};
    this.lastChildId = 0;
    this.myId = 0;
    this.normalDrag = false;
    this.visible = true;
    this.mouseDeltaMultiplier = 1;
    this.dragEndListener;
    
    var me = this;
    this.checkDraggable = function()
    {
        return true;
    };
    
    this.setZIndex = function(setTo)
    {
        me.zIndex = setTo;
    };
    
    this.getZIndex = function()
    {
        return me.zIndex;
    };
    
    this.addChild = function(child)
    {
        me.children[me.lastChildId] = child;
        child.parent = me;
        child.myId = me.lastChildId;
        me.lastChildId++;
        
        return me.lastChildId;
    };
    
    this.removeChild = function(childId)
    {
        child.parent = null;
        
        delete me.children[childId];
    };
    
    this.detatchFromParent = function()
    {
        if(me.parent)
        {
            me.parent.removeChild(me.myId);
        }
    };
    
    var lastMouseX, lastMouseY;
    this.dragMove = function(x, y)
    {
        var nowTime = (new Date()).getTime();
        
        var deltaT = (nowTime - me.dragLastTime) / 100;
        
        var deltaX = x - lastMouseX;
        var deltaY = y - lastMouseY;
        
        if(!me.normalDrag)
        {
            var xComponent = deltaX;
            var yComponent = deltaY;
            var magnitude = Math.sqrt(deltaX*deltaX + deltaY*deltaY);
            
            if(magnitude <= 0.001)
            {
                magnitude = 0.2;
            }
            
            // Normaize.
            xComponent /= magnitude;
            yComponent /= magnitude;
            
            me.xVelocity += xComponent * deltaT * me.mouseDeltaMultiplier;
            me.yVelocity += yComponent * deltaT * me.mouseDeltaMultiplier;
            
            me.dragLastTime = nowTime;
        }
        else
        {
            me.localX += deltaX;
            me.localY += deltaY;
        }
        
        lastMouseX = x;
        lastMouseY = y;
    };
    
    this.dragStart = function(x, y, objects)
    {
        me.frictionK = 1;
        me.dragLastTime = (new Date()).getTime();
        lastMouseX = x;
        lastMouseY = y;
        
        var maxZIndex = HTMLHelper.normalizeZIndiciesAndGetMax(objects, 1);
        
        me.setZIndex(maxZIndex + 1);
        
        if(me.dragStartListener)
        {
            return me.dragStartListener(me);
        }
    };
    
    this.dragEnd = function(x, y)
    {
        me.frictionK = me.originalFriction || 0.98;
        
        if(me.dragEndListener)
        {
            me.dragEndListener(me);
        }
    };
    
    this.setFriction = function(k)
    {
        me.frictionK = k;
        me.originalFriction = k;
    };
    
    this.checkMouseCollision = function(mouseX, mouseY)
    {
        if(!me.visible)
        {
            return false;
        }
    
        return mouseX >= me.x && mouseX <= me.x + me.width 
                && mouseY >= me.y && mouseY <= me.y + me.height;
    };
    
    this.animate = function(nowTime, lastTime, worldObjects, worldProperties)
    {
        if(!me.canExitScreen)
        {
            if(me.x + me.width < me.borderWidth)
            {
                me.xVelocity = 2;
            }
            
            if(me.y + me.height < me.borderWidth)
            {
                me.yVelocity = 2;
            }
            
            if(me.y > worldProperties.height - me.borderWidth)
            {
                me.yVelocity = -2;
            }
            
            if(me.x > worldProperties.width - me.borderWidth)
            {
                me.xVelocity = -2;
                console.warn("AAAH!");
            }
        }
    
        var deltaT = nowTime - lastTime;
        deltaT /= 10.0;
        
        if(me.localX === undefined || me.localY === undefined)
        {
            me.localX = me.x;
            me.localY = me.y;
        }
        
        me.localX += me.xVelocity * deltaT;
        me.localY += me.yVelocity * deltaT;
        
        me.x = me.localX;
        me.y = me.localY;
        
        if(me.parent !== null && me.parent.x && me.parent.y)
        {
            me.x += me.parent.x;
            me.y += me.parent.y;
        }
        
        var appliedFriction = Math.pow(me.frictionK, deltaT);
        me.xVelocity *= appliedFriction;
        me.yVelocity *= appliedFriction;
        
        if(isNaN(me.xVelocity) || isNaN(me.yVelocity))
        {
            me.xVelocity = 0;
            me.yVelocity = 0;
            console.warn("Zeroed x and y velocities! -- Friction: " + appliedFriction);
        }
        
        //console.log("(" + me.x + ", " + me.y + ") -- <" + me.xVelocity + ", " + me.yVelocity + ">");
    };
}

function MovableImage(parent, src, x, y)
{
    DraggableItem.call(this, x, y, 0, 0);
    this.parent = parent;
    this.x = x || 0;
    this.y = y || 0;
    this.localX = 0;
    this.localY = 0;
    this.image = document.createElement("img");//new Image(src);
    this.image.crossOrigin = "";
    this.image.src = src || "";
    
    this.width = this.image.width || 40;
    this.height = this.image.height || 40;
    this.originalWidth = this.width;
    this.originalHeight = this.height;
    this.showBackground = false;
    
    this.xVelocity = 0;
    this.yVelocity = 0;
    this.frictionK = 0.85;
    this.canExitScreen = false;
    this.borderWidth = 20;
    
    this.originalFriction = this.frictionK;
    this.rotation = 0;
    this.scale = 1;
    
    var me = this;
    
    this.image.addEventListener("load", function(e)
    {
        me.width = me.image.width;
        me.height = me.image.height;
        me.originalWidth = me.width;
        me.originalHeight = me.height;
    }, true);
    
    this.setRotation = function(rotation)
    {
        this.rotation = rotation;
    };
    
    this.setScale = function(scale)
    {
        this.scale = scale;
    };
    
    var transformed = false;
    this.rotated90Degrees = function()
    {
        return Math.floor(me.rotation/(Math.PI/2) * 50) === 50;
    }
    
    this.transform = function(reverseT, doNotSwitchWidthAndHeight)
    {
        if(me.rotated90Degrees())
        {
            if(!doNotSwitchWidthAndHeight && (transformed && reverseT || !transformed && !reverseT))
            {
                var temp = me.height;
                me.height = me.width;
                me.width = temp;
            }
            
            if(!reverseT && !transformed)
            {
                me.x += me.height/2 - me.width/2;
                me.y += me.width/2 - me.height/2;
                //me.localX += me.height/2 - me.width/2;
                //me.localY += me.width/2 - me.height/2;
                transformed = true;
            }
            else if(reverseT && transformed)
            {
                me.x -= me.height/2 - me.width/2;
                me.y -= me.width/2 - me.height/2;
                //me.localX -= me.height/2 - me.width/2;
                //me.localY -= me.width/2 - me.height/2;
                transformed = false;
            }
        }
    };
    
    this.render = function(ctx)
    {
        if(!me.visible)
        {
            return false;
        }
    
        if(Math.abs(Math.floor(me.rotation*10)) > 0)
        {
            ctx.strokeRect(me.x, me.y, me.width, me.height);
        }
        
        me.transform(true, true);
        
        me.width = me.originalWidth * me.scale;
        me.height = me.originalHeight * me.scale;
        
        ctx.save();
        ctx.translate(me.x + me.width/2, me.y + me.height/2);
        ctx.rotate(me.rotation * 1);
        
        if(!me.image || me.showBackground)
        {
            ctx.strokeStyle = "rgba(255, 0, 0, 0.3)";
            ctx.lineWidth = 10;
            ctx.strokeRect(-me.width/2, -me.height/2, me.width, me.height);
        }
        
        try
        {
            ctx.drawImage(me.image, -me.width/2, -me.height/2, me.width, me.height);
        }
        catch(e)
        {
            console.error(e);
        }
        
        if(me.additionalRendering)
        {
            me.additionalRendering(ctx, me);
        }
        
        ctx.restore();
        
        me.transform(false, false);
    };
    
    var oldAnimate = this.animate;
    this.animate = function(nowTime, lastTime, worldObjects, worldProperties)
    {
        oldAnimate.apply(me, arguments);
        
        transformed = false;
        me.transform(false, false);
        
        if(me.rotated90Degrees())
        {
            me.height = me.originalWidth * me.scale;
            me.width = me.originalHeight * me.scale;
        }
    };
    
    this.setImage = function(image)
    {
        me.width = image.width || 100;
        me.height = image.height || 100;
        me.originalWidth = me.width;
        me.originalHeight = me.height;
        me.image = image;
        
        image.addEventListener("load", function(e)
        {
            me.width = image.width;
            me.height = image.height;
            me.originalWidth = me.width;
            me.originalHeight = me.height;
        });
    };
}

function GameCharacter(parent, src, x, y)
{
    MovableImage.apply(this, [parent, src, x, y]);
    
    this.xVelocity = 0;
    this.yVelocity = 0;
    this.frictionK = 0;
    this.normalDrag = true;
    this.canExitScreen = true;
    this.playerCharacter = true;
    this.showBackground = true;
    this.extraVisionDistance = 0;
    
    var me = this;
    this.checkDraggable = function()
    {
        if(!AuthorizationHelper.hasAccess && !me.playerCharacter)
        {
            return false;
        }
        else if(!window.authorization.currentUser || !AuthorizationHelper.hasAccess && me.userId !== window.authorization.currentUser.uid)
        {
            return false;
        }
        
        return true;
    };
    
    this.additionalRendering = function(ctx)
    {
        me.showBackground = me.playerCharacter;
        ctx.font = "italic 10px Sans";
        ctx.textBaseline = "top";
        ctx.textAlign = "left";
        ctx.fillStyle = "green";
        ctx.shadowColor = "rgba(255, 0, 0, 0.8)";
        ctx.shadowBlur = 5;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = -1;
        
        var text = "";
        
        if(me.playerCharacter || AuthorizationHelper.hasAccess)
        {
            text += me.name + " ";
        }
        
        if(AuthorizationHelper.hasAccess)
        {
            text += (me.classType || "N/A") + "  lv. " + (me.level || 0) + "; " + (me.hp || 0);
        }
         
        ctx.fillText(text, -me.width/2, -me.height / 2);
    };
}

function CanvasBackground(parent, src, x, y)
{
    MovableImage.apply(this, [parent, src, x, y]);
    
    this.xVelocity = 0;
    this.yVelocity = 0;
    this.frictionK = 0.95;
    this.mouseDeltaMultiplier = 3;
    this.normalDrag = false;
    this.canExitScreen = false;
    this.borderWidth = 20;
    
    this.setFriction(0.97);
}

function StatusText()
{
    this.element = document.createElement("div");
    this.element.setAttribute("class", "statusText");
    
    var me = this;
    this.hide = function()
    {
        me.element.style.display = "none";
    };
    
    this.show = function()
    {
        me.element.style.display = "block";
    };
    
    this.fadeIn = function()
    {
        me.element.style.filter = "opacity(0%)";
        me.show();
        
        //setValueFunction, start, stop, duration, onComplete, doRound, suffix
        HTMLHelper.transitionProperty(function(value) { me.element.style.filter = "opacity(" + value + "%) sepia(" + (100 - value) + "%)"; },
            0, 100, 1000, function()
        {
            // On complete.
        }, false, 0);
    };
    
    this.fadeOut = function()
    {
        //setValueFunction, start, stop, duration, onComplete, doRound, suffix
        HTMLHelper.transitionProperty(function(value) { me.element.style.filter = "opacity(" + value + "%) sepia(" + (100 - value) + "%)"; },
            100, 0, 1000, function()
        {
            setTimeout(function()
            {
                me.hide();
            }, 100);
        }, false, 0);
    };
    
    this.load = function()
    {
        document.body.appendChild(me.element);
        me.hide();
        
        CommunicationHelper.addResourceListener("gameData/statusText", function(statusText)
        {
            if(statusText === null || (new Date()).getTime() - (statusText.timeStamp || 0) >= (statusText.duration || 1000))
            {
                return;
            }
            
            me.element.innerHTML = HTMLHelper.textToHTML(statusText.text);
            
            if(statusText.backgroundColor)
            {
                me.element.style.backgroundColor = statusText.backgroundColor;
            }
            
            if(statusText.color)
            {
                me.element.style.color = statusText.color;
            }
            
            me.fadeIn();
            
            setTimeout(function()
            {
                me.fadeOut();
            }, statusText.duration || 1000);
        });
    };
}

function ZoomControl(initialZoom)
{
    this.ctx;
    this.zoom = initialZoom || 100;
    
    var me = this;
    
    this.element = document.createElement("div");
    this.zoomOutButton = HTMLHelper.addButton("-", function(){ me.zoom -= 5; }, this.element);
    this.zoomInButton = HTMLHelper.addButton("+", function(){ me.zoom += 5; }, this.element);
    
    me.element.setAttribute("class", "zoomDiv");
    document.body.appendChild(me.element);
    
    this.handleCtx = function(ctx)
    {
        me.ctx = ctx;
        
        var getDistance = function(x1, y1, x2, y2)
        {
            return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2));
        };
        
        var lastDistance = 0;
        var first = true;
        me.ctx.canvas.addEventListener("touchstart", function(event)
        {
            if(event.changedTouches.length === 2)
            {
                event.preventDefault();
                var x1 = event.changedTouches[0].clientX;
                var x2 = event.changedTouches[1].clientX;
                
                var y1 = event.changedTouches[0].clientY;
                var y2 = event.changedTouches[1].clientY;
                
                lastDistance = getDistance(x1, y1, x2, y2);
            }
            
            first = true;
        }, true);
        
        
        me.ctx.canvas.addEventListener("touchmove", function(event)
        {
            if(event.changedTouches.length === 2)
            {
                event.preventDefault();
                var x1 = event.changedTouches[0].clientX;
                var x2 = event.changedTouches[1].clientX;
                
                var y1 = event.changedTouches[0].clientY;
                var y2 = event.changedTouches[1].clientY;
                
                var currentDistance = getDistance(x1, y1, x2, y2);
                
                var distanceDelta = currentDistance - lastDistance;
                
                if(distanceDelta !== 0 && me.ctx.canvas.width !== 0 && !first)
                {
                    me.zoom *= (distanceDelta / me.ctx.canvas.width + 1);
                }
                first = false;
                
                lastDistance = currentDistance;
            }
        }, true);
        
        me.ctx.canvas.addEventListener("touchend", function(event)
        {
            if(event.changedTouches.length === 2)
            {
                event.preventDefault();
                first = true;
            }
        }, true);
    };
    
    this.zoomTo = function(ctx)
    {
        (ctx || me.ctx).scale(me.zoom / 100, me.zoom / 100);
    };
    
    this.unZoom = function(ctx)
    {
        if(me.zoom !== 0)
        {
            (ctx || me.ctx).scale(1 / me.zoom * 100, 1 / me.zoom * 100);
            return true;
        }
        else
        {
            return false;
        }
    };
    
    this.zoomPoint = function(x, y)
    {
        return {"x": x / me.zoom * 100, "y": y / me.zoom * 100 };
    };
    
    this.unZoomPoint = function(x, y)
    {
        return {"x": x * me.zoom / 100, "y": y * me.zoom / 100 };
    };
    
    this.getRelativeWidth = function()
    {
        return me.ctx.canvas.width / me.zoom * 100;
    };
    
    this.getRelativeHeight = function()
    {
        return me.ctx.canvas.height / me.zoom * 100;
    };
    
    this.hide = function()
    {   
        me.element.style.display = "none";
    };
    
    this.show = function()
    {   
        me.element.style.display = "block";
    };
    
    this.getZoom = function()
    {
        return me.zoom / 100;
    };
}

function Application()
{
    this.loaded = false;
    this.objects = [];
    this.characterHash = {};
    this.visibleRadius = 1;
    
    this.statusText = new StatusText();
    
    this.background = new CanvasBackground(this);
    this.zoomControl = new ZoomControl(50);
    this.zoomControl.hide();
    this.pointerDown = false;
    
    var me = this;
    this.hideAllCharacters = function()
    {
        for(var i in me.characterHash)
        {
            if(me.characterHash[i] && me.characterHash[i].globalHide)
            {
                me.characterHash[i].globalHide();
            }
        }
    };
    
    var currentlyDragging = null;
    this.elementPointerDown = function(clientX, clientY)
    {
        var point = me.zoomControl.zoomPoint(clientX, clientY);
        clientX = point.x;
        clientY = point.y;
        
        currentlyDragging = null;
        
        for(var index = 0; index < me.objects.length; index++)
        {
            if(me.objects[index].checkMouseCollision(clientX, clientY)
                && me.objects[index].checkDraggable())
            {
                currentlyDragging = me.objects[index];
            }
        }
        
        if(currentlyDragging === null && me.background.checkMouseCollision(clientX, clientY))
        {
            currentlyDragging = me.background;
        }
        
        if(currentlyDragging !== null)
        {
            currentlyDragging.dragStart(clientX, clientY, me.objects);
            
            me.zIndexSort();
        }
        
        me.pointerDown = true;
    };
    
    this.getShown = function()
    {
        return me.loaded && me.element && me.element.style && me.element.style.display !== "none";
    };
    
    this.addObject = function(object)
    {
        object.index = me.objects.length;
        me.objects.push(object);
        
        me.background.addChild(object);
    }
    
    this.zIndexSort = function()
    {
        me.objects.sort(function(a, b)
        {
            return a.getZIndex() - b.getZIndex();
        });
        
        for(var i = 0; i < me.objects.length; i++)
        {
            me.objects[i].index = i;
        }
    };
    
    this.elementPointerMove = function(clientX, clientY)
    {
        var point = me.zoomControl.zoomPoint(clientX, clientY);
        
        clientX = point.x;
        clientY = point.y;
        me.lastMouse = [point.x, point.y];
        
        if(me.pointerDown && currentlyDragging !== null)
        {
            currentlyDragging.dragMove(clientX, clientY);
        }
    };
    
    this.elementPointerUp = function(clientX, clientY)
    {
        var point = me.zoomControl.zoomPoint(clientX, clientY);
        clientX = point.x;
        clientY = point.y;
        
        me.pointerDown = false;
        
        if(currentlyDragging !== null)
        {
            currentlyDragging.dragEnd(clientX, clientY);
            currentlyDragging = null;
        }
    };
    
    this.hide = function()
    {
        if(me.element)
        {
            me.element.style.display = "none";
            me.zoomControl.hide();
        }
        
        if(me.statusText)
        {
            me.statusText.hide();
        }
        
        if(me.ribbon)
        {
            me.ribbon.hide();
        }
        
        if(me.simulation)
        {
            me.simulation.hide();
        }
        
        me.running = false;
    };
    
    this.load = function()
    {
        AuthorizationHelper.defineUserDataIfNeeded();
        
        me.zoomControl.show();
        
        if(me.loaded)
        {
            me.element.style.display = "block";
            
            if(me.ribbon)
            {
                me.ribbon.show();
            }
            
            if(!me.running)
            {
                me.running = true;
                me.renderLoop();
            }
            return;
        }
        
        HTMLHelper.unZoomDocument(false);
        
        me.ribbon = new MainRibbon(me);
        
        if(!AuthorizationHelper.justDidSignUp)
        {
            me.chat = CommunicationHelper.launchChatWindow();
        }
        
        CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.BACKGROUND_SRC, function(backgroundData)
        {
            CommunicationHelper.getImage(backgroundData, function(backgroundSrc, image)
            {
                console.log("Setting background image...");
                if(image !== null)
                {   
                    console.log("Done!");
                    window.i = image;
                    
                    me.background.setImage(image);
                }
                else
                {
                    console.log("Image was " + image);
                }
            });
        });
        
        CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.BACKGROUND_SCALE, function(backgroundScale)
        {
            if(backgroundScale !== null)
            {
                me.background.setScale(backgroundScale);
            }
        });
        
        CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.BACKGROUND_ROTATE, function(backgroundRotation)
        {
            if(backgroundRotation !== null)
            {
                me.background.setRotation(backgroundRotation);
            }
        });
        
        CommunicationHelper.addResourceListener("gameData/visionRadius", function(visionRadius)
        {
            visionRadius = visionRadius || 0;
            
            me.visibleRadius = visionRadius;
        });
        
        me.statusText.load();
        
        var lastAllUsers = {};
        
        var handleCharacter = function(user, key, json)
        {
            if((key + user) in me.characterHash)
            {
                var character = me.characterHash[key + user];
                
                if(!character.visible && json.visible)
                {
                    if(character.needLoadImage)
                    {
                        character.needLoadImage = false;
                        
                        CommunicationHelper.getImage(character.display, function(src, image)
                        {
                            if(image !== null)
                            {   
                                character.setImage(image);
                            }
                        });
                    }
                }
                
                character.visible = json.visible;
                
                return;
            }
            console.log("OK");
            
            var character = new GameCharacter(me);
            
            me.addObject(character);
            
            me.characterHash[key + user] = character;
            character.key = key + user;
            character.webId = key;
            
            
            character.setScale(json.scale || 1.0);
            character.name = json.name;
            character.hp = json.hp;
            
            character.displayF = json.display;
            
            if(character.visible)
            {
                CommunicationHelper.getImage(json.display, function(src, image)
                {
                    if(image !== null)
                    {   
                        character.setImage(image);
                    }
                });
            }
            else
            {
                character.needLoadImage = true;
            }
            
            character.localX = json.position.x;
            character.localY = json.position.y;
            character.playerCharacter = !json.npc;
            character.classType = json.class;
            character.extraVisionDistance = json.vision || 0;
            character.userId = user;
            character.level = json.level || 0;
            
            character.visible = json.visible;
            
            var oldX = json.position.x, oldY = json.position.y;
            
            character.dragStartListener = function(character)
            {
                oldX = character.localX * 1;
                oldY = character.localY * 1;
            };
            
            var updateJSONData = function()
            {
                json.position.x = character.localX;
                json.position.y = character.localY;
                json.visible = character.visible;
                json.scale = character.scale;
                json.name = character.name;
                json.class = character.classType || "";
                json.display = character.displayF;
                json.hp = character.hp;
                json.npc = !character.playerCharacter;
                json.level = character.level || 0;
                json.vision = character.extraVisionDistance;
            };
            
            character.globalHide = function()
            {
                updateJSONData();
                
                var oldVisible = character.visible;
                if(character.visible)
                {
                    json.visible = false;
                    character.visible = false;
                    
                    CharacterControl.updateCharacter(user, character.webId, json, function(success, error, errorDescription)
                    {
                        if(!success && error)
                        {
                            json.visible = oldVisible;
                            console.error(error);
                        }
                    });
                }
            };
            
            character.dragEndListener = function(character)
            {
                console.log("END");
                updateJSONData();
                
                
                CharacterControl.updateCharacter(user, character.webId, json, function(success, error, errorDescription)
                {
                    if(!success && error)
                    {
                        character.localX = oldX;
                        character.localY = oldY;
                    }
                });
            };
        };
        
        AuthorizationHelper.addActiveUserChangeListener(function(uid, allUsers, eventType)
        {
            
            if(me.objects.length === 0)
            {
                CharacterControl.forEveryCharacter(handleCharacter);
            }
            else if(eventType === "signIn")// && !(uid in lastAllUsers))
            {
                CharacterControl.forEveryUserCharacter(uid, handleCharacter);
            }
            else if(eventType === "signOut")
            {
                CharacterControl.forEveryUserCharacter(uid, function(user, key, json)
                {
                    var object = me.characterHash[key + "" + user];
                    
                    if(object)
                    {
                        object.visible = false;
                    }
                });
            }
            
            lastAllUsers = allUsers;
        });
        
        CharacterControl.onCharacterChanged(function(json)
        {
            if((json.character.index + "" + json.uid) in me.characterHash)
            {
                var character = me.characterHash[json.character.index + "" + json.uid];
                character.localX = json.character.position.x;
                character.localY = json.character.position.y;
                character.visible = json.character.visible;
                character.setScale(json.character.scale || 1.0);
                character.name = json.character.name;
                character.hp = json.character.hp;
                character.playerCharacter = !json.character.npc;
                character.extraVisionDistance = json.character.vision || 0;
                character.classType = json.character.class;
                character.level = json.character.level || 0;
                
                if(character.visible && character.needLoadImage)
                {
                    character.needLoadImage = false;
                    
                    CommunicationHelper.getImage(json.character.display, function(src, image)
                    {
                        if(image !== null)
                        {   
                            character.setImage(image);
                        }
                    });
                }
                
                if(character.displayF != json.character.display)
                {
                    character.displayF = json.character.display;
                    
                    if(character.visible)
                    {
                        CommunicationHelper.getImage(json.character.display, function(src, image)
                        {
                            if(image !== null)
                            {   
                                character.setImage(image);
                            }
                        });
                    }
                    else
                    {
                        character.needLoadImage = true;
                    }
                }
            
                console.log("UPDATE: " + (json.character.index + "" + json.uid));
            }
            else
            {
                window.hash = Object.apply({}, me.characterHash);
                window.json = json;
                console.log((json.character.index + "" + json.uid) + " IS NOT IN " + JSON.toString(me.characterHash));
                
                handleCharacter(json.uid, json.character.index, json.character);
            }
            window.h = me.characterHash;
        });
        
        me.element = document.createElement("canvas");
        me.element.style.touchAction = "none !important";
        me.element.style.backgroundColor = "rgba(0, 255, 255, 0.5)";
        me.element.style.animation = "1s linear fadeIn";
        me.element.width = window.innerWidth;
        me.element.height = window.innerHeight;
        me.element.style.position = "absolute";
        me.element.style.top = 0;
        me.element.style.left = 0;
        
        if(window.RoomSimulation)
        {
            try
            {
                var lastCameraPosition = new Vector3(0, 0, 0);
                
                me.simulation = new RoomSimulation(me.element, function(width, height)
                {
                    me.element.width = width || window.innerWidth;
                    me.element.height = height || window.innerHeight;
                }, function(eventType, data)
                {
                    var eventFunctions = 
                    {
                        onmousedown: me.elementPointerDown,
                        onmousemove: me.elementPointerMove,
                        onmouseup: me.elementPointerUp
                    };
                    
                    eventFunctions[eventType](data.clientX, data.clientY);
                    console.log(eventType);
                });
                
                me.simulation.hide();
                
                var lastRotation = 0;
                me.simulation.onCameraMove = function(cameraPosition, cameraRotation)
                {
                    if(cameraPosition.x !== lastCameraPosition.x || cameraPosition.y !== lastCameraPosition.y || cameraPosition.z !== lastCameraPosition.z
                            || cameraRotation.y !== lastRotation)
                    {
                        CommunicationHelper.setData(CommunicationHelper.resourceNames.WORLD_PLAYER_POSITION, 
                        {
                            uid: window.authorization.currentUser.uid,
                            x: cameraPosition.x,
                            y: cameraPosition.y,
                            z: cameraPosition.z,
                            yRotation: cameraRotation.y % (Math.PI * 2)
                        }, function()
                        {
                            console.log("Updated position!");
                        });
                        
                        me.simulation.setPlayerUid(window.authorization.currentUser.uid);
                        
                        lastCameraPosition.x = cameraPosition.x;
                        lastCameraPosition.y = cameraPosition.y;
                        lastCameraPosition.z = cameraPosition.z;
                    }
                };
                
                // Player position listener.
                CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.WORLD_PLAYER_POSITION, function(newData)
                {
                    console.log("Updated player!");
                    me.simulation.updatePlayer(newData.uid, new Vector3(newData.x, newData.y, newData.z), newData.yRotation, (new Date()).getTime());
                });
                
                // Background color listener.
                CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.WORLD_BACKGROUND_COLOR, function(backgroundColor)
                {
                    var backgroundColor = JSHelper.colorStringToArray(backgroundColor || "#ffffff");
                    
                    me.simulation.backgroundColor.r = backgroundColor[0];
                    me.simulation.backgroundColor.g = backgroundColor[1];
                    me.simulation.backgroundColor.b = backgroundColor[2];
                });
                
                // Background cube count listener.
                CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.WORLD_BACKGROUND_CUBE_COUNT, function(cubeCount)
                {
                    if(cubeCount === null || cubeCount === undefined)
                    {
                        cubeCount = 150;
                    }
                    
                    console.log("Changing cube count...");
                    
                    me.simulation.setProperty("cubeCount", cubeCount);
                });
                
                // Time divider listener.
                CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.WORLD_BACKGROUND_TIME_DIVIDER, function(timeDivider)
                {
                    if(timeDivider === null || timeDivider === undefined)
                    {
                        timeDivider = 20;
                    }
                    
                    console.log("Changing time divider...");
                    
                    me.simulation.setProperty("timeDivider", timeDivider);
                });
                
                //"listenOnce": function(resourceName, listener)"setData": function(resourceName, setTo, then)
                
                // WORLD_SHARED_IMAGE
                var retriveImageData = function()
                {
                    CommunicationHelper.listenOnce(CommunicationHelper.resourceNames.WORLD_SHARED_IMAGE, function(sharedImageData)
                    {
                        if(sharedImageData === null || sharedImageData === undefined)
                        {
                            sharedImageData = "dw-S255,0,255,1";
                        }
                        
                        console.log("Changing cube image...");
                        
                        me.simulation.setSharedImageCubeImage(sharedImageData);
                    });
                };
                
                retriveImageData();
                
                var trimSrcIfNeeded = function()
                {
                    var src = me.simulation.getProperty("sharedCubeSrc");
                    if(src.length > 8500)
                    {
                        var beginning = "dw-S255,100,255,1.0bm";
                        var beginningLength = beginning.length;
                        src = beginning + src.substring(src.length - 8500 + beginningLength, src.length);
                        
                        console.warn("Trimming src!");
                        
                        me.simulation.setSharedImageCubeImage(src);
                    }
                    
                    return src;
                };
                CommunicationHelper.addResourceListener(CommunicationHelper.resourceNames.WORLD_SHARED_IMAGE_UPDATE, function(updateData)
                {
                    if(updateData === null || updateData === undefined)
                    {
                        updateData = "";
                    }
                    
                    if(updateData.length > 0)
                    {
                        var firstCharacter = updateData.charAt(0);
                        var content = updateData.substring(1, updateData.length);
                        
                        switch(firstCharacter)
                        {
                            case 'a':
                                console.log("Changing cube image (appending to)...");
                                
                                me.simulation.appendToSharedImageCubeImage(content);
                            break;
                            
                            case 'r':
                                retriveImageData();
                            break;
                        }
                        
                        trimSrcIfNeeded();
                    }
                });
                
                me.simulation.setOnSharedImageCubeSrcChange(function(src, justAdded)
                {
                    src = trimSrcIfNeeded();
                
                    gameData.child("world3DMap").child("sharedCubeImage").set(src).then(
                    function()
                    {
                        console.log("OK! Src changed.");
                    }).catch(function(error)
                    {
                        SubWindowHelper.alert("Sharing changed image error!", error);
                    });
                    
                    CommunicationHelper.setData(CommunicationHelper.resourceNames.WORLD_SHARED_IMAGE_UPDATE, "a" + justAdded, function()
                    {
                        console.log("OK! Src just added changed.");
                    });
                });
            }
            catch(error)
            {
                console.error(error);
                SubWindowHelper.alert("Simulation Loading Error!", error);
            }
        }
        
        HTMLHelper.chainOldAndNew(document.body.onresize, function()
        {
            me.element.width = window.innerWidth;
            me.element.height = window.innerHeight;
            
            if(me.simulation)
            {
                me.simulation.resizeSourceIfNecessary();
            }
        }, function(newResize)
        {
            document.body.onresize = newResize;
        });
        
        // Chain a call to HTMLHelper.eventArgumentToXY(...) with whatever the listener was previously. Prevent default action.
        HTMLHelper.chainOldAndNew(me.element.onmousemove, HTMLHelper.eventArgumentToXY(me.elementPointerMove, true), function(newFunction) { me.element.onmousemove = newFunction; });
        HTMLHelper.chainOldAndNew(me.element.onmousedown, HTMLHelper.eventArgumentToXY(me.elementPointerDown, true), function(newFunction) { me.element.onmousedown = newFunction; });
        HTMLHelper.chainOldAndNew(me.element.onmouseup, HTMLHelper.eventArgumentToXY(me.elementPointerUp, true), function(newFunction) { me.element.onmouseup = newFunction; });
        HTMLHelper.chainOldAndNew(me.element.onmouseleave, HTMLHelper.eventArgumentToXY(me.elementPointerUp, true), function(newFunction) { me.element.onmouseleave = newFunction; });
        
        me.element.addEventListener("touchstart", function(event)
        {
            if(event.changedTouches.length === 1)
            {
                event.preventDefault();
                var touch = event.changedTouches[0];
                me.elementPointerDown(touch.clientX, touch.clientY);
            }
        }, true);
        
        me.element.addEventListener("touchmove", function(event)
        {
            if(event.changedTouches.length === 1)
            {
                event.preventDefault();
                
                var touch = event.changedTouches[0];
                me.elementPointerMove(touch.clientX, touch.clientY);
            }
        }, true);
        
        me.element.addEventListener("touchend", function(event)
        {
            if(event.changedTouches.length === 1)
            {
                event.preventDefault();
                
                var touch = event.changedTouches[0];
                me.elementPointerUp(touch.clientX, touch.clientY);
            }
        }, true);
        
        me.ctx = me.element.getContext("2d");
        
        me.zoomControl.handleCtx(me.ctx);
        
        me.running = true;
        
        me.lastTime = (new Date()).getTime();
        
        document.body.appendChild(me.element);
        
        me.renderLoop();
        
        me.loaded = true;
    };
    
    this.createBackupCtxIfNeeded = function()
    {
        if(!me.backupCtx || me.backupCtx.canvas.width !== me.ctx.canvas.width || me.backupCtx.canvas.height)
        {
            var canvas = document.createElement("canvas");
            canvas.width = me.ctx.canvas.width;
            canvas.height = me.ctx.canvas.height;
            
            me.backupCtx = canvas.getContext("2d");
        }
    };
    
    this.renderLoop = function()
    {
        try
        {
        var nowTime = (new Date()).getTime();
        me.ctx.clearRect(0, 0, me.ctx.canvas.width, me.ctx.canvas.height);
        
        
        var properties = {"width": me.zoomControl.getRelativeWidth(), "height": me.zoomControl.getRelativeHeight()};
        
        me.ctx.save();
        
        if(me.visibleRadius > 0)
        {
            me.createBackupCtxIfNeeded();
            me.backupCtx.save();
            me.zoomControl.zoomTo(me.backupCtx);
        }
        else
        {
            me.zoomControl.zoomTo();
        }
        
        
        try
        {
            var oldBackgroundX = 0, oldBackgroundY = 0, oldBackgroundWidth = 0, oldBackgroundHeight = 0;
            if(me.background != null)
            {
                oldBackgroundX = me.background.x;
                oldBackgroundY = me.background.y;
                oldBackgroundWidth = me.background.width;
                oldBackgroundHeight = me.background.height;
                
                if(me.visibleRadius <= 0)
                {
                    me.background.render(me.ctx);
                }
                else
                {
                    me.background.render(me.backupCtx);
                }
            }
        
        }
        catch(error)
        {
            console.error(error);
        }
        
        if(me.visibleRadius > 0)
        {
            me.backupCtx.drawImage(me.ctx.canvas, 0, 0);
            
            me.ctx.save();
            if(AuthorizationHelper.hasAccess)
            {
                me.ctx.drawImage(me.backupCtx.canvas, 0, 0);
                me.ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
            }
            else
            {
                me.ctx.fillStyle = "black";
            }
            
            me.zoomControl.zoomTo();
            me.ctx.fillRect(oldBackgroundX, oldBackgroundY, oldBackgroundWidth, oldBackgroundHeight);
            me.ctx.restore();
        }
        
        for(var i = 0; i < me.objects.length; i++)
        {
            if(me.visibleRadius > 0)
            {
                if(!me.objects[i].visible)
                {
                    continue;
                }
                
                me.ctx.save();
                me.ctx.beginPath();
                var clipCenter = me.zoomControl.unZoomPoint(me.objects[i].x + me.objects[i].width / 2, me.objects[i].y + me.objects[i].height / 2);
                
                var visionRadius = (me.visibleRadius + me.objects[i].extraVisionDistance);
                if(me.visibleRadius === 1)
                {
                    visionRadius = 1;
                }
                
                me.ctx.arc(clipCenter.x, clipCenter.y, visionRadius * me.zoomControl.getZoom(), 0, Math.PI * 2, true);
                me.ctx.clip();
                
                me.objects[i].render(me.backupCtx);
                
                if(me.objects[i].playerCharacter || AuthorizationHelper.hasAccess)
                {
                    me.ctx.drawImage(me.backupCtx.canvas, 0, 0);
                    
                    if(AuthorizationHelper.hasAccess)
                    {
                        if(!me.objects[i].playerCharacter)
                        {
                            me.ctx.fillStyle = "rgba(0, 255, 0, 0.4)";
                            me.ctx.fillRect(0, 0, me.ctx.canvas.width, me.ctx.canvas.height);
                        }
                        
                        
                    }
                }
                
                me.ctx.restore();
                
                if(me.visibleRadius === 1 && AuthorizationHelper.hasAccess)
                {
                    me.ctx.save();
                    me.ctx.beginPath();
                    me.ctx.arc(clipCenter.x, clipCenter.y, 50 * me.zoomControl.getZoom(), 0, Math.PI * 2, true);
                    if(!me.objects[i].playerCharacter)
                    {
                        me.ctx.strokeStyle = "orange";
                    }
                    else
                    {
                        me.ctx.strokeStyle = "gray";
                    }
                    
                    me.ctx.stroke();
                    me.ctx.restore();
                }
            }
            else
            {
                me.objects[i].render(me.ctx);
            }
        }
        
        if(me.visibleRadius > 0)
        {   
            me.backupCtx.restore();
            
            //properties.width = me.backupCtx.canvas.width;
            //properties.height = me.backupCtx.canvas.height;
        }
        
        
        if(me.lastMouse && me.lastMouse.length > 1 && me.visibleRadius <= 0)
        {
            me.ctx.beginPath();
            me.ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
            me.ctx.arc(me.lastMouse[0], me.lastMouse[1], 10, 0, Math.PI * 2, true);
            me.ctx.fill();
        }
        me.ctx.restore();
        
        if(nowTime - me.lastTime > 15)
        {
        
            me.background.animate(nowTime, me.lastTime, me.objects, properties);
            
            for(var i = 0; i < me.objects.length; i++)
            {
                me.objects[i].animate(nowTime, me.lastTime, me.objects, properties);
            }
        }
        
        me.lastTime = nowTime;
        }catch(e){
        try
        {
            me.ctx.restore();
            me.ctx.restore();
        }
        catch(e)
        {
        
        }
        }
        
        if(me.running)
        {
            requestAnimationFrame(me.renderLoop);
        }
    };
    
    this.close = function()
    {
        if(me.loaded)
        {
            me.running = false;
            document.body.removeChild(me.element);
        }
    };
}

function main()
{
    document.body.innerHTML = "";
    //var app = new Application();
    //app.load();
    
    var signInManager = new SignInManager();
    signInManager.show();
    
    var app = new Application();
    
    AuthorizationHelper.addAuthListener(function()
    {
        if(window.authorization.currentUser === null)
        {
            signInManager.show();
            app.hide();
        }
        else
        {
            signInManager.hide();
            
            if(!app.getShown())
            {
                SubWindowHelper.alert("Signed In!", "You have been signed in!");
                AuthorizationHelper.checkForAccess();
                
                app.load();
            }
        }
    });
    
    AuthorizationHelper.startActiveChangeLoop();
}

try
{
    main();
}
catch(e)
{
    SubWindowHelper.alert("Error", "Caught outside main: " + e);
}
</script>
</html>
